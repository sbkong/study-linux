- **리눅스를 배우는 이유** : 서버 운영 / 개발을 하기 위해서 → 설치 및 구축보다 운영/관리의 빈도가 압도적으로 높다.

# 개요
### IT 인프라 구성
- e.g. 복지콜 시스템 구성도
  ![[Pasted image 20240815164012.png]]

### 영역 구분
- IDC : 인터넷, 백본, 전원(UPS), 항온/항습 
- 정보 보호 시스템 : 방화벽, IPS, IDS, 웹 방화벽, DDOS 방어 장비
- 네트워크 장비 : 백본, 라우터, 스위치, 브릿지
- 서버 : 웹, DB, SMS, CTI

#### 관리 영역
![[Pasted image 20240815170645.png]]

#### 업무 영역
  ![[Pasted image 20240815164137.png]]

| 항 목                    | 업무내용                                                                                                                                                                                                                                                                               | 업무주기   |
| ---------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------ |
| 분석/설계/검토               | - 시스템 구성에 대한 분석/설계<br>- 로그 저장 및 관리에 설계<br>- 백업관리와 대한 설계<br>- 장애 재발 방지를 위한 검토                                                                                                                                                                                                       | 월간     |
| H/W구축                  | - 장비 견적/발주/납품<br>- 장애에 대한 부품교체                                                                                                                                                                                                                                                     | 비정기    |
| H/W, N/W 구성 변경         | - 하드웨어 마운트 (랙 케이블, 전원연결)<br>- H/W 추가<br>- N/W 구성 변경                                                                                                                                                                                                                                | 비정기    |
| H/W Upgrade            | - HDD 추가 및 교체<br>- CPU 추가 및 교체<br>- RAM 추가 및 교체<br>- RAID CARD 추가 및 교체                                                                                                                                                                                                             | 비정기    |
| OS Install / Reinstall | - OS 설치<br>- OS 기본 보안 설정<br>- OS 기본 환경 설정                                                                                                                                                                                                                                          | 비정기    |
| SW Install / Reinstall | - OS 및 각 서비스 설치, 설정<br>- 메일, FTP, DNS등 설치 및 설정<br>- 기타 SW 설치<br>- DB 및 WEB 분산 환경 구성                                                                                                                                                                                                | 비정기    |
| Data Migration         | - Data migration<br>- Config migration                                                                                                                                                                                                                                             | 비정기    |
| Tuning                 | - 튜닝을 위한 스트레스 테스트 및 자원 측정<br>- 테스트 완료 후 자원 맞춤 및 튜닝<br>- SW 튜닝<br>- 웹 및 SW 스트레스 테스트 및 자원 측정<br>- 테스트 결과에 대한 반영                                                                                                                                                                      | 필요시    |
| **모니터링**               | **- 트래픽 모니터링<br>- 서버 Up&Down 모니터링<br>- 프러세스, 메모리, 부하 감시<br>- 서비스(웹, DB, FTP, DNS, 메일)모니터링**                                                                                                                                                                                        | **수시** |
| **정기 점검**              | **1. 보안점검<br>- 백도어, Root, SetUid파일, tmp디렉토리 점검<br>- Listen 포트 점검<br>- Linux 기본 방화벽 (iptables, tcp_wrapper) 점검<br>- 비인가 SW 점검<br>- chkrootkit 을 이용한 rootkit 점검<br>- 보안 패치 신규 권고문 적용 및 패치 이력 관리<br>- 서비스 재설치 및 패치이력 점검<br>- 정기 취약점 점검(Nessus등 활용)<br>- 쉬운 비밀번호 점검 (수시로 계정 추가/삭제 시)** | **매월** |
| 예방 점검                  | - 보안패치/보안점검 (크리티컬 이슈 발생 시 수시)                                                                                                                                                                                                                                                      | 매분기    |
| 백업 정책                  | - 백업 정책 설정: 주기, 보관 기간, 백업 대상, 복원 방법<br>- 백업 설정                                                                                                                                                                                                                                     | 비정기    |
| 복원 관리                  | - 복원 이력 관리 (일시/사용/내역)                                                                                                                                                                                                                                                              | 비정기    |
| 장애처리                   | - N/W 장애처리<br>- H/W 장애처리<br>- 설치한 SW 장애처리<br>- 처리 → 원인분석 → 보고/재발 방지<br>- 장애 처리 Hot 라인 구성                                                                                                                                                                                           | 발생시    |
| 설정변경                   | - OS 설정 변경<br>- Application 설정 변경<br>- 기타 설정 변경                                                                                                                                                                                                                                    | 필요시    |
| Update/Upgrade         | - 펌웨어 Update<br>- Kernel, OS Update<br>- 서버 S/W 업데이트/업그레이드                                                                                                                                                                                                                         | 필요시    |
| 이력관리 및 리포팅             | - 시스템 구성도 유지<br>- H/W 장비 변경 내역 관리<br>- S/W Update/Patch이력 관리<br>- 백업 및 이력 관리<br>- 장애처리 이력관리<br>- 설정 변경/유지 이력관리                                                                                                                                                                     | 변경, 주기 |
| Documentation          | - OS 설치 문서화<br>- OS 기본 보안 설정 및 환경 설정 문서화<br>- SW 설치에 대한 문서화<br>- Data 이관/마이그레이션 문서화                                                                                                                                                                                                | 비정기    |

# 모니터링
- 수시로 수행
### 대표 명령어 정리
| 명령어                   | 용 도                                        |
|--------------------------|---------------------------------------------|
| gnome-system-monitor     | 시스템 종합 모니터링 프로그램(GUI)             |
| top                      | 시스템 종합 모니터링 도구(TUI)                 |
| htop                     | 향상된 top                                  |
| glance                   | 더욱 향상된 top                              |
| vmstat                   | 시스템 전반적인 사용량 확인                   |
| dstat                    | 시스템의 다양한 상태 모니터링                 |
| sar                      | 시스템 정보 수집, 리포트, 저장                |
| pstree                   | 프로세스 트리 출력                           |
| ps                       | 프로세스 상세정보 확인                       |
| pidstat                  | 과부하 프로세스 조회                         |
| strace                   | 프로세스의 시스템 콜 및 시그널 추적           |
| lsof                     | 열린 파일 및 소켓 조회                       |
| free                     | 메모리 사용량 조회                           |
| slabtop                  | SLAB 모니터링                                |
| iptraf-ng                | 트래픽, 패킷 모니터링 및 통계 도구            |
| ethtool                  | 네트워크 인터페이스 확인 및 설정              |
| netstat                  | 네트워크 인터페이스 통계 및 기타 정보 확인    |
| powertop                 | 전력관련 프로세스 확인 및 절전탐구            |
| cpupower                 | CPU 주파수 확인 및 설정                      |
| df                       | 파일 시스템 사용량 확인                      |
| iotop                    | 각 프로세스별 I/O 사용량 모니터링             |
| iostat                   | 각 디바이스별 I/O 조회                       |
| lsblk                    | 블록 디바이스 및 파일시스템 조회              |
| findmnt                  | 트리형태의 마운트 된 내역 확인               |
| tune2fs                  | 파일시스템 정보 확인                         |
| xfs_info                 | xfs 파일시스템 정보 확인                     |
| lspci                    | PCI 장치 조회                                |
| lsusb                    | USB 장치 조회                                |
| tmon                     | 온도 확인 및 냉각장치 조절                    |

- 효율적인 관리를 위해 솔루션을 사용하기도 함
	- Network Management System
	- System Management System

#### 모니터링 해야 하는 부분
![[Pasted image 20240816100748.png]]

### 종합 성능 모니터링 도구
#### GUI
- 프로그램 → 시스템 도구 → 시스템 정보
- 혹은 터미널에서 다음 명령어 입력
  `gnome-system-monitor`
#### **`top`** - 종합 시스템 모니터
- 가시 항목
	- 시스템 가동시간
	- 접속자 수
	- 평균 부하
	- 태스크 수
	- 프로세스 통계
	- CPU 사용률
	- IO Wait
	- 메모리
	- Swap
	- 프로세스

![[Pasted image 20240816102142.png]]
> [!info] h 키를 누르면 도움말을 볼 수 있다.

##### htop, glances
- 향상된 top
- Reference
	- [htop](https://docs.rockylinux.org/ko/gemstones/htop/)
	- [Glances](https://glances.readthedocs.io/en/latest/index.html)

#### **`vmstat`** - 개략적인 시스템 사용량 확인
- 가시 항목
	- 프로세스
	- 메모리
	- 페이징
	- 블럭장치 I/O
	- CPU

![[Pasted image 20240816110350.png]]

| 구분        | 항목        | 설명                                                                                       |
|-------------|-------------|--------------------------------------------------------------------------------------------|
| procs       | r           | 실행할 수 있는(실행 중 또는 대기 중인) 프로세스 수                                          |
|             | b           | 인터럽트를 할 수 없는 sleep 상태의 프로세스(예: 대규모 Disk I/O가 끝나기를 기다리는 프로세스) |
| memory      | swpd        | SWAP 메모리 사용량                                                                           |
|             | free        | 사용하지 않는 메모리의 양                                                                    |
|             | buff        | 버퍼로 사용하고 있는 메모리의 양                                                             |
|             | cache       | 캐시로 사용하고 있는 메모리의 양                                                             |
| swap        | si          | 디스크로부터 스왑된 메모리의 양 (swapped in)                                                 |
|             | so          | 메모리에서 디스크로 스왑된 메모리의 양 (swapped out)                                        |
| io          | bi          | 블록장치로부터 받은 바이트 수 (blocks in)                                                    |
|             | bo          | 블록장치로 보낸 바이트 수 (blocks out)                                                       |
| system      | in          | 초당 인터럽트 수 (interrupts)                                                               |
|             | cs          | 초당 context switches(문맥 교환)의 수                                                        |
| CPU         | us          | 사용자 CPU 사용 시간(%)                                                                      |
|             | sy          | 커널 CPU 사용 시간(%)                                                                        |
|             | id          | CPU가 쉬는 시간(%)                                                                           |
|             | wa          | I/O 작업 대기(CPU 대기 시간) (%)                                                             |
|             | st          | 가상머신으로부터 도난당한 CPU 시간(%)                                                       |


##### `dstat` - vmstat, iostat, netstat, ifstat 정보 통합
- `yum install dstat`
- alias를 설정해서 손쉽게 사용하기 (`/root/.bashrc`일에 추가)
```bash
alias dstat='dstat --time --cpu --net --disk --sys --load --proc --top-cpu'
```
- [how to use](http://dag.wiee.rs/home-made/dstat/)

#### **`sar`** - 시스템 정보 수집, 리포트, 저장
- [[sysstat-sar 명령 옵션]]

#### `pstree` - 프로세스 트리 출력
- 프로세스 실행 관계를 파악할 때 사용

##### 옵션

| 옵션  | 의미                                                          |
| --- | ----------------------------------------------------------- |
| -a  | 명령어에 인수를 넣어 실행했다고 명령어 인수까지 함께 보여준다.                         |
| -c  | 독립적인 하위라도 보여지지 않는다. 같은 위치에 같은 프로세스가 있을 때는 하나로 합쳐서 보여주지 않는다. |
| -h  | 현재 프로세스와 부모 프로세스를 좀 더 두드러지게 출력한다.                           |
| -n  | 특별히 긴 줄이 있어도 그대로 보여준다.                                      |
| -p  | PID도 출력한다.                                                  |
| -u  | UID도 출력한다.                                                  |
| -G  | VT100 터미널 모드에서 보는 것과 동일하게 출력하여 프로세스 간의 관계를 보기 좋게 출력한다.      |
| -V  | 버전정보를 보여주고 끝낸다.                                             |

#### **`ps`** - 프로세스 상세 정보
![[Pasted image 20240816120911.png]]

| 항목                     | 의미                                                         |
|--------------------------|--------------------------------------------------------------|
| PID(process ID)           | 프로세스마다 주어지는 번호                                    |
| TTY(TeleTypewriter)       | 명령어가 실행되는 터미널의 번호, 할당된 것이 없는 경우 물음표(?) 출력  |
| STAT                      | 실행되고 있는 프로세스 상태(R,S,D,T,Z,W,N)                   |
| START                     | 프로세스가 시작된 시간                                       |
| TIME                      | CPU가 사용한 시간                                            |
| USER                      | 사용자의 이름                                                |
| COMMAND                   | 사용자가 실행한 명령어                                        |
| UID(User ID)              | 사용자의 ID                                                  |
| PGID(Parent Group ID)     | 사용자 부모 프로세스의 그룹 ID                               |
| SID(Session ID)           | 세션 ID                                                     |
| PRI(PRiority)             | 실행하는 우선순위에 따른 프로세스                             |
| NI(NIce)                  | nice에 의한 우선순위에 따른 프로세스                          |
| RSS(Resident Set Size)    | 프로세스가 사용한 메모리의 크기                               |
| SZ(Size)                  | 프로세스가 사용하는 자료와 스택의 크기                        |
| SHRD(SHaRD)               | 프로세스가 사용하는 공유메모리                                |
| %CPU                      | 프로세스가 사용하는 CPU 점유율                               |
| %MEM                      | 프로세스가 사용하고 있는 메모리 점유율                        |
| WCHAN                     | 프로세스가 실행하고 있는 커널 루틴                            |


##### 옵션

| 옵션  | 의미                                                                                             |
|-------|--------------------------------------------------------------------------------------------------|
| -a    | 세션 리더와 터미널과 연관이 없는 프로세스를 제외한 모든 프로세스를 출력한다.                         |
| a      | BSD 스타일로서 터미널과 연관된 모든 프로세스를 출력하거나, x 옵션과 함께 사용되어 모든 프로세스를 출력한다.  |
| -d    | 세션 리더를 제외한 모든 프로세스를 출력한다.                                                       |
| -e    | 모든 프로세스를 출력한다. -A와 동일한 옵션이다.                                                     |
| -r    | 실행 중인 프로세스만 출력한다.                                                                     |
| x      | BSD 스타일로서 혼자 사용되며 사용자에 의해 소유된 모든 프로세스를 출력하고 e 옵션과 함께 사용되어 모든 프로세스를 출력한다. |
| -l    | 상세한 내용을 출력한다. -c 옵션은 단순한 정보를 출력한다.                                            |
| -f    | 아주 완전한 형식(extra full format)으로 출력한다.                                                  |
| -F    | 완전한 형식의 목록을 출력한다.                                                                     |
| -h    | 메뉴는 보여주지 않는다(PID, TTY, STAT, TIME, COMMAND 등).                                           |
| -j    | 작업에 관련된 ID를 출력한다.                                                                       |
| -l    | -j 옵션보다 자세하게 정보를 출력한다.                                                              |
| -u    | 사용자 친화적인 형식으로 출력한다.                                                                 |
| -y    | 플래그(flags)를 보여주지 않는다. addr 대신 rss를 보여준다. 이 옵션은 -1 옵션과 함께만 사용될 수 있다. |
| -e    | 명령에 따른 환경들을 함께 출력한다(-e 옵션과 다르다).                                              |
| f      | 프로세스 간 상속관계를 트리구조로 보여준다.                                                        |
| n      | 사용자의 정보를 (모든 형식의 UID와 GID를 포함하여) 숫자로 표시한다.                                 |
| -w    | 출력결과를 생략하지 않고 넓게 출력한다(W 옵션도 동일하다).                                           |
##### 자주 사용하는 옵션
```
ps -e
ps ax
ps axu

___
ps ax | grep mysqld
ps ax | more
```
#### `pidstat` - 과부하 프로세스 조회
- sysstat 패키지 설치 필요
- [[pidstat 명령 옵션]]

#### `strace` - 프로세스의 시스템 콜 및 시그널 추적
- `strace` 패키지 설치 필요 

| 명령어                       | 설명                                                    |
| ------------------------- | ----------------------------------------------------- |
| `strace -o strace.txt df` | df 프로그램 실행 시 발생되는 시스템 콜과 시그널 확인<br>→ 파일로 저장           |
| `strace -e trace=open df` | 특정 시스템 콜 open만 출력.<br>프로그램 실행 시 어떤 파일을 사용하는 지 알 수 있다. |
| `strace -p {PID}`         | 실행중인 프로세스 추적<br>`{PID}`는 프로세스ID                       |
| `strace -f -p {PID}`      | folk되는 프로세스도 함께 추적                                    |
| `strace -t -p {PID}`      | 시간 정보 출력                                              |
| `strace -r -p {PID}`      | 시스템 콜에 소요되는 시간 출력                                     |
| `strace -c df`            | 시스템 콜 통계                                              |

#### **`lsof`** - 열린 파일 및 소켓 조회
- 프로세스가 사용 파일 및 소켓을 확인할 수 있다.

![[Pasted image 20240816123717.png]]

| 항목      | 설명                                                                                   |
|-----------|----------------------------------------------------------------------------------------|
| COMMAND   | 실행한 명령어                                                                            |
| PID       | 프로세스 ID                                                                             |
| USER      | 실행한 사용자                                                                            |
| FD        | File Descriptor(파일 기술자)                                                             |
|           | cwd : current working directory(현재 디렉토리)                                           |
|           | rtd : root directory(최상위 경로)                                                        |
|           | mem : memory-mapped file(메모리에 매핑된 파일)                                           |
|           | mmap : memory-mapped device(메모리에 매핑된 장치)                                        |
|           | pd : parent directory(부모 디렉토리)                                                    |
|           | txt : program text(프로그램 코드와 데이터)                                               |
| TYPE      | 파일 종류                                                                                |
|           | IPv4 : IPv4 소켓                                                                        |
|           | DIR : 디렉토리                                                                           |
|           | CHR : character special file(문자장치 파일)                                              |
|           | REG : regular file(일반파일)                                                            |
|           | unix : 유닉스 도메인 소켓                                                                |
| DEVICE    | 장치 번호                                                                                |
| SIZE/OFF  | 파일의 크기나 오프셋                                                                     |
| NODE      | 노드 번호                                                                                |
| NAME      | 파일명                                                                                   |

##### 옵션

| 명령어                            | 설명                                                                                                     |
| ------------------------------ | ------------------------------------------------------------------------------------------------------ |
| `lsof -u {user-name}`          | `{user-name}` 사용자가 실행한 프로세스의 열린 파일 확인                                                                  |
| `lsof -i`                      | 네트워크 소켓 정보 조회<br>`lsof -i 4`<br>`lsof -i TCP`<br>`lsof -i TCP:21-22`<br>`lsof -n -P -i @192.168.0.201` |
| `lsof -c {process-name}`       | `{process-name}` 프로세스의 열린 파일 확인                                                                        |
| **`lsof {file-path}`**         | `{file-path}` 파일을 사용하는 프로세스 확인                                                                         |
| **`lsof +D {directory-path}`** | `{directory-path}` 디렉터리를 사용하는 프로세스 확인                                                                  |
| **`lsof -p {process-id}`**     | `{process-id}` 특정 프로세스가 사용하는 파일 확인                                                                     |

### 메모리 모니터링
#### **`free`** - 메모리 사용량 조회
![[Pasted image 20240816154610.png]]

##### `cat /proc/meminfo` - 상세 정보
![[Pasted image 20240816154832.png]]

#### `slaptop` - 메모리계의 top
- `top` 명령어와 비슷한 화면을 출력하고 실시간으로 모니터링 할 수 있는 화면 제공
- `vmstat -m` 과 같은 결과

### 네트워크 모니터링
#### **`netstat`** - 네트워크 인터페이스 통계 및 기타 정보 확인
![[Pasted image 20240816161654.png]]

| 항목            | 설명                                                                                     |
|-----------------|------------------------------------------------------------------------------------------|
| Proto           | 현재 소켓이 사용하고 있는 프로토콜                                                        |
| Recv-Q          | 사용자의 프로그램이 아직 복사해 가지 않은 바이트 수이다. 즉, 받은 패킷 중에서 큐(Receive Queue)에 대기 중인 바이트 |
| Send-Q          | 연결된 원격 호스트가 가져가지 않은 바이트 수이다. 즉, 보낼 큐(Send Queue)에 대기 중인 바이트  |
| Local Address   | 로컬 호스트 주소와 포트번호                                                               |
| Foreign Address | 원격 호스트의 주소와 포트번호                                                             |
| State           | 소켓의 상태 (소켓의 상태는 다음 표와 같다.)                                               |

- 소켓의 상태

| 상태           | 설명                                                                                       |
|----------------|--------------------------------------------------------------------------------------------|
| ESTABLISHED    | 소켓이 연결되어 있다.                                                                        |
| SYN_SENT       | 소켓이 동작중이고 연결을 하려고 시도 중이다.                                                   |
| SYN_RECV       | 네트워크로부터 연결 요청을 받았다.                                                           |
| FIN_WAIT1      | 소켓의 연결이 끊어지고, 연결이 중단되고 있는 중이다.                                          |
| FIN_WAIT2      | 연결이 끊어지고, 소켓이 원격의 연결종단을 기다리고 있다.                                      |
| TIME_WAIT      | 소켓이 네트워크상에 있는 패킷을 처리하기 위해 대기 중이다.                                    |
| CLOSED         | 소켓이 사용 중이 아니다.                                                                     |
| CLOSE_WAIT     | 원격지에서 연결을 중단했고 소켓이 끝나기를 기다리고 있다.                                      |
| LAST_ACK       | 원격지의 연결이 중단되고, 소켓은 끝났다. ACK을 기다리고 있는 상태                              |
| LISTEN         | 소켓이 연결을 기다리고 있는 상태. -l (--listening), -a (--all) 옵션을 주지 않으면 보이지 않는다. |
| CLOSING        | 양쪽에서 연결을 끊었지만 아직 보내지 않은 데이터가 있는 상태                                   |
| UNKNOWN        | 소켓의 상태가 파악되지 않는 상태                                                              |

##### 옵션

| 옵션     | 설명                                                                        |
| ------ | ------------------------------------------------------------------------- |
| -a     | --all과 같으며 listen되는 소켓정보와 listen 되지 않는 소켓정보 모두 보여줌.                       |
| **-n** | --numeric과 같으며 10진수의 수치정보로 결과를 출력해줌.                                      |
| -r     | --route와 같으며 설정된 라우팅 정보를 출력해줌.                                            |
| **-p** | --program과 같으며 실행되고 있는 각 프로그램과 PID 정보를 출력함.                               |
| **-i** | --interface=iface와 같으며 모든 네트워크 인터페이스 정보를 출력함. 또는 특정 네트워크 인터페이스를 지정할 수 있음. |
| -c     | --continuous와 같으며 netstat 결과를 연속적으로 출력함.                                  |
| **-l** | --listening과 같으며 listen 되고 있는 소켓 정보를 출력함.                                 |
| -s     | --statistics와 같으며 각 프로토콜에 대한 통계정보를 출력함.                                   |

#### `iptraf-ng` - 트래픽 모니터링
- `iptraf-ng` 패키지 설치 필요
  `yum install iptraf-ng`
- `iptraf-ng` 명령어 사용시 TUI 프로그램 실행됨
  ![[Pasted image 20240816155551.png]]

| 항목                            | 설명                                |
| ----------------------------- | --------------------------------- |
| IP traffic monitor            | IP/Port 별 패킷 수+전송량 측정             |
| General Interface statistics  | 장치 별 트래픽+패킷 등 확인                  |
| Detailed interface statistics | 프로토콜 통계                           |
| Statistical breakdowns        | 패킷 사이즈 별 통계                       |
| LAN station monitor           | 프로토콜 및 포트별 패킷 모니터링<br>MAC 기반 모니터링 |
| Filters                       | 여러가지 항목 필터링 가능                    |

#### `ethtool` - 네트워크 인터페이스 확인 및 설정
- `ethtool` 패키지 설치 필요
- 주로 네트워크 속도 측정을 위해 사용, 혹은 네트워크 속도 강제 변경

- `ethtool {network-interface-name}`
![[Pasted image 20240816161039.png]]

##### 설정 변경
- `ethtool -s {network-interface-name} autoneg off speed 100`
	- auto-negotiation off
	- speed 100MBps 로 변경

### 전력 모니터링
#### `powertop` - CPU를 자주 깨우는 구성요소 확인 및 튜닝
- `powertop` 패키지 설치 필요

```
~] # powertop
```
![[Pasted image 20240816162913.png]]
> [!info] tab 키를 누르면 다음 탭으로 이동한다.


| 탭 항목            | 설명                                                                   |
| --------------- | -------------------------------------------------------------------- |
| Overview        | CPU를 자주 깨우는 요소 확인                                                    |
| Idle stats      | 유휴 통계<br>C0 : 전력 소모 높음, 가장 빠르게 깨어날 수 있음<br>Cn : 전력 소모 낮음, 깨어나는 속도 느림 |
| Frequency stats | 주파수 통계. 클럭이 낮을수록 전력소모가 적음                                            |
| Device stats    | 디바이스 통계<br>CPU,GPU, 디스플레이 백라이트 통계                                    |
| Tunables        | 절전 튜닝                                                                |

- 조사 결과 html 내보내기 : `powertop --html`

#### [`cpupower`](https://docs.redhat.com/ko/documentation/red_hat_enterprise_linux/8/html/monitoring_and_managing_system_status_and_performance/tuning-cpu-frequency-to-optimize-energy-consumption_monitoring-and-managing-system-status-and-performance#tuning-cpu-frequency-to-optimize-energy-consumption_monitoring-and-managing-system-status-and-performance) - powertop과 비슷함

### 블록 디바이스 모니터링
#### **`df`** - 디바이스 사용량 조회
##### 사용량 조회 + 디바이스 타입 조회
![[Pasted image 20240816164346.png]]

##### inode 조회
> [!info] inode : 파일의 메타데이터를 저장하는 데 사용. 가용 inode가 없으면 파일을 생성할 수 없다.

![[Pasted image 20240816164412.png]]

#### **`iostat`** - 각 디바이스 별 I/O 상세 조회

##### `iostat` - 장치 별 통계
![[Pasted image 20240816164920.png]]

##### `iostat -p` - 파티션 별 통계
- `iostat -p 1 2` 옵션으로 실시간 모니터링 옵션 제공
![[Pasted image 20240816165039.png]]

#### `iotop` - I/O 실시간 모니터링
- `iotop`패키지 설치 필요

### 파일 시스템 모니터링
#### *`lsblk`* - 블록 디바이스 조회 (가끔 사용)
##### `lsblk` - 디스크 및 파티션 확인
![[Pasted image 20240816165217.png]]

##### `lsblk -t` - 디스크 및 파티션 topology 확인
![[Pasted image 20240816165258.png]]

##### `lsblk -S` - 디스크 정보 확인
![[Pasted image 20240816165346.png]]

##### `lsblk -o` - 원하는 옵션만 출력
![[Pasted image 20240816165526.png]]

#### [`findmnt`](https://man7.org/linux/man-pages/man8/findmnt.8.html) - 디바이스 트리 형태로 출력
#### `tune2fs -l` - ext2, 3, 4 파일 시스템 정보 확인
`tune2fs -l /dev/sda1`
![[Pasted image 20240816170116.png]]

#### `xfs_info` - xfs 파일 시스템 정보 확인
`xfs_info /dev/sda1`

### 하드웨어 정보 확인
#### `lspci` - PCI 디바이스 확인
`lspci | grep USB` 
![[Pasted image 20240816170311.png]]

#### `lsusb` - USB 장치 확인
##### `lsusb -t` - 트리 형태로 출력
![[Pasted image 20240816170506.png]]
##### `lsusb -v -s` - 장치 상세 정보
`lsusb -v -s 001:001` : Bus 001:Device 001
![[Pasted image 20240816170729.png]]

#### `lscpu` - 장착된 모니터 정보 확인
- `/proc/cpuinfo` 파일의 내용을 열어봐도 확인 가능

#### `tmon` - 온도 확인 및 냉각 장치 조절

# 정기 점검
- 월 1회 수행
- 목적 : 서버 증설, 운영 정책 마련 등

### 정기 점검 기록부
![[Pasted image 20240816171547.png]]

### 사용 명령어

| 명령어     | 용 도                                              |
|------------|---------------------------------------------------|
| route      | 라우팅 테이블 관리                                  |
| ifconfig   | 네트워크 인터페이스 관리                             |
| ip         | 네트워크 전반적인 관리 도구                          |
| dmidecode  | DMI테이블 확인(서버 모델, CPU, RAM 등 확인)          |
| lsblk      | 디바이스 및 파티션, 디스크 정보 조회                 |
| hdparm     | 디스크 관리도구                                      |
| uname      | 커널등 시스템 정보 출력                              |
| netstat    | 네트워크 정보 출력                                   |
| ps         | 프로세스 상세 정보 출력                              |
| uptime     | 시스템 가동시간 및 평균 부하 출력                     |
| free       | 메모리 및 SWAP 사용량 조회                           |
| sar        | 전반적인 시스템 사용량 조회                          |
| df         | 디바이스, 파티션 사용량 조회                         |
| tune2fs    | 파일시스템 정보 조회(오류 검사)                      |
| smartctl   | Disk SMART 값 조회(디스크 오류 검사)                 |

### 서버 정보 확인

#### 네트워크 정보 확인
- `rount -n` - 장치명 및 게이트웨이 ip 확인
![[Pasted image 20240816172832.png]]

- `ifconfig` 혹은 `ip addr` - IP 확인
![[Pasted image 20240816173001.png]]

### 하드웨어 정보 확인

#### 서버 모델 확인 
- 눈으로 확인 하는 것이 좋음
 -`dmidecode -s system-prpduct-name`
![[Pasted image 20240816174548.png]]
- `-s` 까지 입력하고 엔터를 입력하면 사용할 수 있는 옵션 목록이 나열됨
#### CPU 모델 확인
- `dmidecode -s processor-version` 혹은 `cat /proc/cpuinfo`
![[Pasted image 20240816174931.png]]

#### 메모리 정보 확인
- `dmidecode -t memory`
![[Pasted image 20240816175008.png]]
![[Pasted image 20240816175059.png]]

#### 디스크 정보 확인
- `fdisk -l` 혹은 `lsblk`
![[Pasted image 20240816175151.png]]

- 상세 정보 - `hdparm -i {device-name}`
![[Pasted image 20240816175226.png]]
### 소프트웨어 정보 확인

#### OS 정보 확인
- `cat /etc/centos-release`
- `cat /etc/os-release` (ubuntu)
![[Pasted image 20240816175438.png]]

#### 커널 버전 확인
- `uname -r`
![[Pasted image 20240816175517.png]]
#### 아키텍쳐 확인
- `arch`
![[Pasted image 20240816175537.png]]

#### 웹서버 종류 및 버전 확인
- `netstat -anp | grep :{web-sever-port}`
![[Pasted image 20240816175714.png]]

- `ps -ef | grep httpd`
![[Pasted image 20240816175831.png]]

#### WAS 종류 및 버전 확인
- `{TOMCAT_HOME}/bin/version.sh`
![[Pasted image 20240817105042.png]]
#### DB서버 종류 및 버전 확인
- `netstat -nlp | grep -w LISTEN`
![[Pasted image 20240817104833.png]]

- `ps -ef | grep -w mysqld`
![[Pasted image 20240817105329.png]]

- `/usr/sbin/mysqld --version`
![[Pasted image 20240817105447.png]]
#### 메일서버 종류 및 버전 확인
- `netstat -anp | grep :25`
- `ps -ef | grep master`
- `rpm -qf /usr/sbin/postfix/master`
- `postconf mail_version`

### 자원 점검

#### 서버 가동일 수 : uptime
- `uptime`
![[Pasted image 20240817105641.png]]

#### 15분 평균 부하 점검 : uptime

#### 메모리 사용량 점검 : free
- `free -h`
![[Pasted image 20240817105943.png]]

#### 총 프로세스 수 : ps -efL
- `ps -efL | wc -l`
![[Pasted image 20240817110038.png]]

#### SWAP 사용량 : free

#### CPU 사용량 : sar
- `sar`
![[Pasted image 20240817110143.png]]

### 디스크 점검

#### 80% 이상 파티션 점검 : df
- `df -h`
![[Pasted image 20240817110203.png]]

- `df -ih`
![[Pasted image 20240817110243.png]]
#### 파일 시스템 오류 점검 : tune2fs 혹은 xfs_repair
- `tune2fs -l {partition-name}` : ext 파일 시스템일 경우
  `fsck {partition-name}`

- `xfs_repair -n {partition-name}` : xfs 파일 시스템일 경우
#### SMART 값 점검 : smartctl
- `smartmontools` 패키지 설치
- `smartctl -A {partition-name}` 
![[Pasted image 20240817110710.png]]

##### 주요 항목
- SMART 5 - Reallocated_Sector_Count
  어떠한 이유로 디스크 섹터의 데이터를 다른 곳으로 옮김. 치명적인 오류는 아니기 때문에 한 달 정도 지켜보고 수치가 바뀌지 않으면 사용해도 무관함.
- SMART 187 - Reported_Uncorrectable_Errors
- SMART 188 - Command_Timeout
- SMART 197- Current_Pending_Sector_Count
  배드섹터 수. 빠른 시일 내에 교체 필요
- SMART 198 - Offline_Uncorrectable

위 항목의 수치가 0이 아닐 경우 디스크 교체 필요

- [Reference](https://www.backblaze.com/blog/what-smart-stats-indicate-hard-drive-failures/)
### 네트워크 점검

#### Collisions 점검 (이더넷 충돌)
- `ifconfig | grep collisions`
![[Pasted image 20240817114539.png]]

혹은,

- `ip -s link | grep -A 1 collsns`
![[Pasted image 20240817114640.png]]
#### Packet Errors 점검
- `ifconfig | grep error`
![[Pasted image 20240817114712.png]]

혹은,

- `ip -s link | grep -A 1 errors`
![[Pasted image 20240817114741.png]]
# Backup 및 복구

### 사용 명령어

| 명령어    | 용 도                                  |
|-----------|----------------------------------------|
| crontab   | 주기적인 작업 관리 도구                 |
| vi        | 편집기                                  |
| mc        | TUI 파일브라우저                        |
| rsync     | 빠르고 범용적인 원격 및 로컬 파일 복사 도구 |
| mysql     | MySQL CLI 클라이언트                    |
| mysqldump | MySQL Dump 도구                         |

### 로컬 압축 백업

| 항목    | 설명                                                                             |
| ----- | ------------------------------------------------------------------------------ |
| 주기    | 매일 1회                                                                          |
| 압축여부  | 압축                                                                             |
| 보관기간  | 3일 (변경 가능)                                                                     |
| 백업 대상 | /bin, /boot, /data, /etc/, /home, /lib, /lib64, /opt, /root, /sbin, /usr, /var |
| 저장 경로 | /backup/날짜/*.tar.gz                                                            |
| 프로그램  | /root/backupCompress                                                           |
| 백업시간  | 새벽 1시 시작                                                                       |
| 기타    | 홈 디렉토리의 경우 home.사용자.tar.gz으로 압축한다.                                             |
|       | 홈 디렉토리 압축 해제를 위해 restore.home.sh 파일을 만들어 일괄처리할 수 있게 한다.                        |
| 장점    | 압축 백업하기 때문에 백업 공간 절약                                                           |
| 단점    | - 백업시간에 압축으로 인한 CPU부하 증가 및 긴 백업시간                                              |
|       | - 복구 시 압축해제로 인한 CPU부하 증가 및 긴 복구시간                                              |
|       | - 중간/변경/삭제된 데이터만 백업 불가                                                         |

##### 수행
- 스크립트 : [[backupCompress.sh]]
- 실행 권한 변경
  `chmod 700 backupCompress.sh`
- Crontab 등록
  `crontab -e`
```crontab
00 01 * * * su - root -c 'backupCompress.sh' // 추가 (backupCompress.sh 파일 경로 확인)
```

##### 확인
- `ls -al /backup` (backupCompress.sh 파일에서 설정한 백업 경로)
##### 복구
- backup 디렉터리에서 백업된 디렉터리의 날짜를 제거하고 원본 디렉터리와 교체한다.
### 요일별 rsync 백업

| 항목    | 설명                                                                             |
| ----- | ------------------------------------------------------------------------------ |
| 주기    | 매일 1회                                                                          |
| 압축여부  | 안함                                                                             |
| 보관기간  | 일주일(고정)                                                                        |
| 백업 대상 | /bin, /boot, /data, /etc/, /home, /lib, /lib64, /opt, /root, /sbin, /usr, /var |
| 저장 경로 | /backup/요일/*                                                                   |
| 프로그램  | /root/backupRsyncWeeks                                                         |
| 백업시간  | 새벽 1시 시작                                                                       |
| 기타    | 매일 해당요일의 경로에 백업                                                                |
| 장점    | - rsync 사용 변경데이터 백업으로 CPU부하 및 백업시간 단축                                          |
|       | - 최장 일주일의 백업 데이터 유지                                                            |
| 단점    | - 백업 공간이 원본데이터의 7배 필요                                                          |
|       | - 최초 일주일은 full 백업으로 긴 백업시간                                                     |

##### 수행
- 스크립트 : [[backupRsyncWeeks.sh]]
- 실행 권한 변경
  `chmod 700 backupRsyncWeeks.sh`
- Crontab 등록
  `crontab -e`
```crontab
00 01 * * * su - root -c 'backupRsyncWeeks.sh'
```

##### 확인
- `ls -al /backup`
##### 복구
- backup 디렉터리에서 백업된 디렉터리의 날짜를 제거하고 원본 디렉터리와 교체한다.

### 일정기간 rsync 백업

| 항목        | 설명                                                                                                   |
|-------------|--------------------------------------------------------------------------------------------------------|
| 주기        | 매일 1회                                                                                               |
| 압축여부    | 안함                                                                                                    |
| 보관기간    | 3일 (변경 가능)                                                                                        |
| 백업 대상   | /bin, /boot, /data, /etc/, /home, /lib, /lib64, /opt, /root, /sbin, /usr, /var                          |
| 저장 경로   | /backup/숫자/*                                                                                          |
| 프로그램    | /root/woo0.backupRsyncNumber                                                                           |
| 백업시간    | 새벽 1시 시작                                                                                          |
| 기타        | 1970년 1월 1일부터 현재까지 일자%n(3일)의 나머지 숫자                                                      |
| 장점        | - rsync 사용 변경데이터 백업으로 CPU부하 및 백업시간 단축                                                 |
|             | - 백업 기간 변경 가능                                                                                  |
| 단점        | - 백업 공간이 원본데이터의 n배 필요                                                                     |
|             | - 최초 한 번은 full 백업으로 긴 백업시간                                                                |

##### 수행
- 스크립트 : [[backupRsyncNumber.sh]]
- 실행 권한 변경
  `chmod 700 backupRsyncNumber.sh`
- Crontab 등록
  `crontab -e`
```crontab
00 01 * * * su - root -c 'backupRsyncNumber.sh'
```

##### 확인
- `ls -al /backup`
##### 복구
- backup 디렉터리에서 백업된 디렉터리의 날짜를 제거하고 원본 디렉터리와 교체한다.

### rsync 변경파일 따로 보관

| 항목        | 설명                                                                                                 |
|-------------|------------------------------------------------------------------------------------------------------|
| 주기        | 매일 1회                                                                                             |
| 압축여부    | 안함                                                                                                  |
| 보관기간    | 30일(변경 가능)                                                                                      |
| 백업 대상   | /bin, /boot, /data, /etc/, /home, /lib, /lib64, /opt, /root, /sbin, /usr, /var                        |
| 저장 경로   | /backup/fullbackup/*                                                                                 |
|             | /backup/old/*                                                                                        |
| 프로그램    | /root/woo0.backupRsyncHistory                                                                        |
| 백업시간    | 새벽 1시 시작                                                                                        |
| 기타        | 당일 백업데이터는 /backup/fullbackup에 저장                                                           |
|             | 변경된 데이터는 /backup/old/해당경로/파일-날짜                                                       |
| 장점        | - rsync 사용 변경데이터 백업으로 CPU부하 및 백업시간 단축                                             |
|             | - 변경/삭제데이터만 별도 누적 보관                                                                   |
|             | - 변경된 데이터를 별도 보관하기 때문에 백업 공간 효율적 사용                                          |
| 단점        | - 변경된 파일의 날짜를 찾아 복구해야 하기 때문에 복구의 어려움                                        |

##### 수행
- 스크립트 : [[backupRsyncHistory.sh]]
- 실행 권한 변경
  `chmod 700 backupRsyncHistory.sh`
- Crontab 등록
  `crontab -e`
```crontab
00 01 * * * su - root -c 'backupRsyncHistory.sh'
```

##### 확인
- `ls -al /backup`

##### 복구
- backup 디렉터리에서 백업된 디렉터리의 날짜를 제거하고 원본 디렉터리와 교체한다.

### MySQL 시간별 Dump

| 항목        | 설명                                                                                     |
|-------------|------------------------------------------------------------------------------------------|
| 주기        | 매시 1회                                                                                 |
| 압축여부    | 압축 (변경 가능)                                                                         |
| 보관기간    | 360시간(변경 가능)                                                                       |
| 백업 대상   | MySQL DB                                                                                 |
| 저장 경로   | /backup/DB/날짜/*/*.sql[.gz]                                                             |
| 프로그램    | /root/woo0.backupMySQLDump                                                               |
| 백업시간    | 매시 03분                                                                                |
| 기타        | DB명.테이블명.sql[.gz]으로 백업                                                          |
| 장점        | - 매시 Dump 백업으로 데이터 누적 보관                                                     |
|             | - 압축보관으로 백업 공간 최소화                                                          |
|             | - 각 테이블별 백업으로 특정 테이블 복구 용이                                              |
| 단점        | - 잦은 백업으로 서버 부하 증가                                                            |

##### 수행
- 스크립트 : [[backupMySQLDump.sh]]
- 실행 권한 변경
  `chmod 700 backupMySQLDump.sh`
- Crontab 등록
  `crontab -e`
```crontab
03 * * * * su - root -c 'backupMySQLDump.sh'
```

##### 확인
- `ls -al /backup`

##### 복구
- 다음 중 하나 사용

1. {table-name}.sql 파일을 mysql 프로그램을 사용하여 리스토어한다.
2. `zcat {table-name}.sql.gz | mysql -u root {DB-name}` 명령어 사용

# 로그 확인 및 관리
### 사용 명령어

| 명령어      | 용 도                                      |
|-------------|--------------------------------------------|
| logview     | 시스템로그 확인 프로그램(GUI)               |
| journalctl  | systemd 로그 검색 프로그램                  |
| logwatch    | 통합 로그분석 프로그램                     |
| goaccess    | 실시간 웹로그 분석 프로그램 (TUI)           |
| rsyslog     | 유닉스 및 리눅스 로그 시스템               |
| logrotate   | 로그 로테이트 프로그램                     |
| LogAnalyzer | 로그 조회 및 분석 프로그램 (WEB)           |

### 로그 점검

#### 시스템 로그 : logview(GUI)
- 프로그램 → 시스템 도구 → 시스템 로그
- terminal에서 `logview` 입력
#### **journalctl : systemd 로그 검색**
##### 로그 저장 ~ 조회 흐름
![[Pasted image 20240817162605.png]]
##### 각 서비스 유닛 별 로그 검색
- `journalctl -u {service-name} -a`
![[Pasted image 20240817152943.png]]

##### 중요도에 따른 로그 검색
- `journalctl -p {중요도}`
![[Pasted image 20240817153038.png]]

| Level | 중요도       | 설명  |
| :---: | :-------- | :-- |
|   0   | EMERGENCY | 응급  |
|   1   | ALERT     | 경보  |
|   2   | CRITICAL  | 심각  |
|   3   | ERROR     | 오류  |
|   4   | WARNING   | 경고  |
|   5   | NOTICE    | 알림  |
|   6   | INFO      | 정보  |
|   7   | DEBUG     | 디버깅 |
- 각 Level은 하위 레벨을 포함한 결과를 출력함

##### 기간 설정 로그 검색
- `journalctl --since="2024-04-01 00:00:00" --until="-60 minutes"`
![[Pasted image 20240817155029.png]]

#### 시스템 로그 파일
- `rsyslog`에 의해 저장되는 로그
- `cat`, `tail`, `more`, `less` 등의 명령어로 조회 가능

| 로그파일   | 설명                                                                 |
|------------|----------------------------------------------------------------------|
| messages   | 인증, 메일, cron을 제외한 대부분의 로그가 기록되는 파일               |
| secure     | 인증 즉 보안 관련 로그가 저장되는 파일                                |
| maillog    | 메일 관련 모든 로그가 저장되는 파일                                   |
| cron       | cron관련 모든 로그가 저장되는 파일                                    |
| spooler    | uucp, news의 심각한 로그가 저장되는 파일                              |
| boot.log   | 부팅 메시지가 저장된 로그파일                                        |

#### 각종 로그파일
##### 기타 로그
- `/var/log` 디렉터리의 기타 로그

| 로그파일           | 설명                                                                                                     |
|--------------------|--------------------------------------------------------------------------------------------------------|
| Xorg.0.log         | XWindow 관련 로그 파일                                                                                  |
| btmp               | 로그인 실패기록이 담긴 바이너리 로그 파일. `lastb -f /var/log/btmp2`로 확인 가능.                       |
| dmesg              | 커널의 링버퍼 내용이 Text로 저장된 로그 파일. `dmesg` 명령으로 확인할 수 있으며, `dmesg` 명령은 `/dev/kmsg`를 읽어 보여준다. |
| firewalld          | firewalld 서비스 관련 로그가 저장되는 로그파일                                                           |
| lastlog            | 사용자의 최근 로그인 정보를 보관한 파일. `lastlog` 명령어 사용 시 참고하는 파일이다.                   |
| pm-powersave.log   | 절전을 위해 절전 모드로 변환하는 파워퀵인 `pm-powersave`에서 기록하는 로그                             |
| tallylog           | 접속 실패 내역을 잠고 기록하며 사용하는 PAM성 모듈 `pam_tally2` 모듈이 기록하는 바이너리 로그 파일       |
|                    | `pam_tally2`를 사용하기 위해서는 PAM설정을 해야 하며, `pam_tally2` 프로그램으로 내용을 확인할 수 있다.   |
| wtmp               | 로그인이 기록이 담긴 바이너리 로그 파일. `last` 명령어에 의해 보여진다. `lastb -f /var/log/wtmp` 명령으로 확인 가능하다. |
| xferlog            | FTP 서버에서 기록하는 파일 전송기록이 담긴 로그파일                                                      |
| yum.log            | 패키지 관리도구 `yum`의 활동기록이 저장된 로그파일                                                      |

##### 주요 서비스 로그

| 디렉토리     | 로그파일        | 설명                                                          |
| -------- | ----------- | ----------------------------------------------------------- |
| anaconda | *           | anaconda는 CentOS 설치프로그램이며 설치과정의 여러 로그를 저장하고 있다.             |
| audit    | audit.log   | audit(리눅스 침입(Audit) 탐색) 로그                                  |
| chrony   | *           | chrony NTP 서버/클라이언트 로그                                      |
| cups     | *           | CPUS 프린트 시스템 관련 로그                                          |
| gdm      | *           | GDM(GNOME Display Manager)관련 로그                             |
| httpd    | access_log  | 웹서버 접근로그 파일                                                 |
|          | error_log   | 오류 로그 파일                                                    |
| mariadb  | mariadb.log | MariaDB 오류 로그 파일                                            |
|          | query.log   | 모든 쿼리에 대한 로그 파일 (설정 필요)                                     |
|          | slow.log    | 지정한 초 이상 수행시간이 소요되는 쿼리를 기록한 로그파일 (설정 필요)                    |
|          | bin-log     | 추가/삭제/변경과 관련된 쿼리와 작성한 바이너리 로그파일 (설정 필요)                     |
|          | relay-log   | Replication 구성 시 Master 서버에서 가져온 bin-log 내용을 저장한 바이너리 로그 파일 |
| sa       | *           | sar에서 사용하는 로그파일이며 대부분 참조 한다.                                |
| samba    | log.nmbd    | nmbd 관련 로그 파일                                               |
|          | log.smbd    | smbd 관련 로그 파일                                               |
|          | log.호스트     | 각 호스트에서 접속한 기록                                              |
| squid    | *           | squid 프록시 서버의 로그파일                                          |


#### 통합 로그 분석 : Logwatch
- CentOS에서 제공하는 통합 로그 분석 패키지
  `yum install logwatch`
- 기본 제공 서비스는 아래 표와 같다.


##### 설정(메일 전송)
- `cat /etc/logwatch/conf/logwatch.conf`
![[Pasted image 20240817160640.png]]

기본 설정을 복사해서 사용하자.
- `cp /usr/share/logwatch/default.conf/logwatch.conf /etc/logwatch/conf/logwatch.conf`
![[Pasted image 20240817160801.png]]

그리고 복사한 파일에서 아래 항목을 수정한다.

```bash
### /etc/logwatch/conf/logwatch.conf

#Output = stdout
Output = email

#Format = text
Format = html

#Mailto = root
Mailto = sbkong@triniti.kr
```

설정한 email에서 결과를 확인할 수 있다.
#### 실시간 웹로그 분석 프로그램 : GoAccess
- http://goaccess.io/

- 분석 항목
	- 일반 통계, 트래픽 사용량
	- 요청에 대한 소요 시간
	- IP별 누적 방문자 통계
	- 요청 파일 통계
	- 요청에 대한 HTTP 상태 코드, 코드에 따른 통계
	- 클라이언트 IP에 대한 국가 위치
	- 브라우저, OS, 이전 페이지에 대한 통계
	- HTML,CSV,JSON 형태 출력

### 로그 관리
#### rsyslog 관리
- CentOS6 이전 : syslog 
  6 이후 : rsyslog - 향상된 멀티 쓰레드 syslog 데몬
- MySQL, syslog/TCP, RFC 3195, 허용된 발송자 리스트, 메시지 필터링, 출력 형식 제어 등의 기능을 제공
##### 로그 관리 흐름
![[Pasted image 20240817163152.png]]

- 설정 파일 : 주 설정 파일에서 설정파일의 내용을 읽고 적용한다.
	- 주 설정 파일 : `/etc/rsyslog.conf`
	- 설정 파일 :  `/etc/rsyslog.d/*.conf`
- [reference](https://docs.redhat.com/ko/documentation/red_hat_enterprise_linux/7/html/system_administrators_guide/ch-viewing_and_managing_log_files#ch-Viewing_and_Managing_Log_Files)

##### 설정
###### `/etc/rsyslog.conf` - 주 설정 내용
```bash
# rsyslog configuration file

# For more information see /usr/share/doc/rsyslog*/rsyslog_conf.html

# If you experience problems, see http://www.rsyslog.com/doc/troubleshoot.html

#### MODULES ####

# The imjournal module below is now used as a message source instead of imuxsock.
# Use imuxsock if you want to process local system logging (e.g., via logger command)
$ModLoad imjournal # provides access to the systemd journal
# $ModLoad imklog # reads kernel messages (the same are read from journald)
# $ModLoad immark # provides --MARK-- message capability

# Provides UDP syslog reception
$ModLoad imudp
$UDPServerRun 514

# Provides TCP syslog reception
$ModLoad imtcp
$InputTCPServerRun 514

```
- 모듈 로딩 설정
	- im : 입력 모듈 (input)
		- imuxsock : 시스템 로그 소켓을 포함한 유닉스 소켓 입력 모듈
		- imjournal : CentOS7 이후의 입력 모듈
	- om : 출력 모듈 (output)
		- imudp : UDP/514를 통한 로그 수신에 사용
		- imtcp : TCP/514

###### `/etc/rsyslog.conf` - 전역 설정
```bash
#### GLOBAL DIRECTIVES ####

# Where to place auxiliary files
$WorkDirectory /var/lib/rsyslog

# Use default timestamp format
$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat

# File syncing capability is disabled by default. This feature is usually not required,
# not useful and an extreme performance hit
#$ActionFileEnableSync on

# Include all config files in /etc/rsyslog.d/
$IncludeConfig /etc/rsyslog.d/*.conf

# Turn off message reception via local log socket;
# local messages are retrieved through imjournal now.
$OmitLocalLogging on

# File to store the position in the journal
$IMJournalStateFile imjournal.state

```
- `$WorkDirectory /var/lib/rsyslog`: 작업 디렉토리를 설정
- `$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat`: 기본 남겨질 시간 포맷을 전통적인 방식으로 설정 한다. 이 설정이 없으면 RFC3339 포맷으로 남겨진 시간이 출력되어 2015-10-02T15:00:00Z와 같은 형식으로 남겨진다.
- `$ActionFileEnableSync on`: 이 설정은 기본 값이 off이다. 주석을 제거하고 on으로 한다는 것은 바뀌를 사용하지 않기 때문에 성능에 영향이 있다.
- `$IncludeConfig /etc/rsyslog.d/*.conf`: 다른 설정 파일을 가져온다.
- `$OmitLocalLogging on`: 이 설정은 imuxsock의 사용유무를 설정하는 지시자이다. 기본값은 off이다.
- `$IMJournalStateFile imjournal.state`: 이 설정은 imjournal 모듈의 상태파일의 이름을 정하는 것이다. 해당 파일은 작업 디렉토리 내 생성되며 `/var/lib/rsyslog/imjournal.state` 파일이 생긴다.

###### `/etc/rsyslog.conf` - 규칙 설정 : 각 로그파일에 기록될 내용이 결정
```bash
#### RULES ####

# Log all kernel messages to the console.
# Logging much else clutters up the screen.
#kern.*                                                  /dev/console

# Log anything (except mail) of level info or higher.
# Don't log private authentication messages!
*.info;mail.none;authpriv.none;cron.none                 /var/log/messages

# The authpriv file has restricted access.
authpriv.*                                               /var/log/secure

# Log all the mail messages in one place.
mail.*                                                   -/var/log/maillog

# Log cron stuff
cron.*                                                   /var/log/cron

# Everybody gets emergency messages
*.emerg                                                  :omusrmsg:*

# Save news errors of level crit and higher in a special file.
uucp,news.crit                                           /var/log/spooler

# Save boot messages also to boot.log
local7.*                                                 /var/log/boot.log

```
- `*.kern.* /dev/console`: 커널 관련 메시지는 `/dev/console`로 보낸다는 것이다. `/dev/console`은 콘솔 화면이다. 주석처리가 되어 있어 설정되지 않은 것이다.
- `*.info;mail.none;authpriv.none;cron.none /var/log/messages`: mail, authpriv, cron을 제외한 모든 시설(facility)의 중요도가 info 이상인 로그를 `/var/log/messages` 파일에 기록하도록 설정한다. 인증, 메일, 크론을 제외한 대부분의 로그는 messages로그에 남아 있기 때문에 `messages`는 아주 중요한 로그이다. RFC3164에 명시된 중요도 및 포함된 시설은 다음과 같다.

| 중요도             | 숫자코드 | 중요도 및 포함관계 | 설명  |
| --------------- | ---- | ---------- | --- |
| emerg (=panic)  | 0    | EMERGENCY  | 응급  |
| alert           | 1    | ALERT      | 정보  |
| crit            | 2    | CRITICAL   | 심각  |
| err (=error)    | 3    | ERROR      | 오류  |
| warn (=warning) | 4    | WARNING    | 경고  |
| notice          | 5    | NOTICE     | 알림  |
| info            | 6    | INFO       | 정보  |
| debug           | 7    | DEBUG      | 디버그 |

그리고 RFC3164에 명시된 시설(facility)은 다음 키워드 중 하나이다.

| Facility       | 숫자코드 | 설 명                                |
|----------------|----------|--------------------------------------|
| kern           | 0        | 커널 메시지                          |
| user           | 1        | 사용자 레벨 메시지                   |
| mail           | 2        | 메일 시스템                          |
| daemon         | 3        | 시스템 데몬                          |
| auth (=security)| 4       | 보안/인증 메시지                     |
| syslog         | 5        | syslogd에 의해 생성된 메시지          |
| lpr            | 6        | 라인프린터 관련 메시지               |
| news           | 7        | 네트워크 뉴스 관련 메시지            |
| uucp           | 8        | UUCP                                 |
| cron           | 9        | 시계 데몬                            |
| authpriv       | 10       | 보안/인증 메시지                     |
| ftp            | 11       | FTP 데몬                             |
| -              | 12       | NTP 시스템 메시지                    |
| -              | 13       | 감사(Audit) 로그                     |
| -              | 14       | 경고(alert) 로그                     |
| cron           | 15       | 시계 데몬(스케줄 데몬)               |
| local0         | 16       | 로컬 0                               |
| local1         | 17       | 로컬 1                               |
| local2         | 18       | 로컬 2                               |
| local3         | 19       | 로컬 3                               |
| local4         | 20       | 로컬 4                               |
| local5         | 21       | 로컬 5                               |
| local6         | 22       | 로컬 6                               |
| local7         | 23       | 로컬 7                               |

- `authpriv.*` 
  인증관련 모든 로그는 `/var/log/secure`에 저장한다.
- `mail.*` 
  메일 관련 모든 로그는 `/var/log/maillog`에 저장한다. rsyslog는 로그 저장 후 커널에 의해 `fsync`를 호출한다. 파일의 앞에 `-`를 입력하면 로그 저장 후 `fsync`를 호출하지 않기 때문에 시스템 문제가 발생해도 경우 로그를 잃을 수 있다. 중요도가 낮은 로그의 경우 `-`를 붙여 로그 기록 성능을 향상시킬 수 있다.
- `cron.*`
  cron 관련 모든 로그는 `/var/log/cron`에 저장한다.
- `*.emerg`
  응급 메시지의 경우 모든 사용자에게 메시지를 보낸다. `\* 대신, 로` 구분된 사용자 ID를 입력하여 특정 사용자에게만 보낼 수 있다.
- `uucp,news.crit` 
  uucp, news의 심각한 로그의 경우 `/var/log/spooler`에 저장한다.
- `local7.*`
  local7과 관련된 모든 로그는 `/var/log/boot.log`에 저장한다. `local7`은 부팅 메시지를 위해 사용된다.

###### 로그 포워딩 설정
```bash
#### begin forwarding rule ####
# The statement between the begin ... and end define a SINGLE forwarding
# rule. They belong together, do NOT split them. If you create multiple
# forwarding rules, duplicate the whole block!
# Remote Logging (we use TCP for reliable delivery)

# An on-disk queue is created for this action. If the remote host is
# down, messages are spooled to disk and sent when it is up again.
$ActionQueueFileName fwdRule1 # unique name prefix for spool files
$ActionQueueMaxDiskSpace 1g   # 1gb space limit (use as much as possible)
$ActionQueueSaveOnShutdown on # save messages to disk on shutdown
$ActionQueueType LinkedList   # run asynchronously
$ActionResumeRetryCount -1    # infinite retries if host is down
# remote host is: name/ip:port, e.g. 192.168.0.1:514, port optional
*.* @@remote-host:514
#### end of the forwarding rule ####

```
대표적인 설정은 로그를 로그서버에 보내는 설정은 다음과 같다.
- `*.* @@remote-host:514` 모든 로그를 remote-host서버의 TCP/514를 사용하여 로그를 전송한다. 
- `*.* @remote-host:514` : 만약 UDP/514
- `*.* :omrelp:remote-host:2514` : 좀 더 신뢰성 있는 RELP(Reliable Event Logging Protocol)

##### 운영
- `systemctl` 명령어로 서비스를 운영한다.
	- `systemctl [start/restart/stop/status] rsyslog`
#### 로그 로테이트(logrotate)
- 로그 파일의 크기를 제한 (로그 파일 분리, 압축)
- 과거 로그를 규칙에 따라 제거

###### 설정
- `/etc/loglotate.conf`
```bash
# see "man logrotate" for details
# rotate log files weekly - 주기
weekly

# keep 4 weeks worth of backlogs - 최대 개수
rotate 4

# create new (empty) log files after rotating old ones - 로테이트 후 신규 파일 생성
create

# use date as a suffix of the rotated file - 로테이트 파일 뒤에 날짜를 붙인다.
dateext

# uncomment this if you want your log files compressed - 압축 설정
#compress

# RPM packages drop log rotation information into this directory - RPM 패키지들의 로그 파일 설정
include /etc/logrotate.d

# no packages own wtmp and btmp -- we'll rotate them here - /var/log/wtmp,btmp 파일에 대한 로그 로테이트 설정
/var/log/wtmp {
    monthly
    create 0664 root utmp
	minsize 1M
    rotate 1
}

/var/log/btmp {
    missingok
    monthly
    create 0600 root utmp
    rotate 1
}

# system-specific logs may be also be configured here.

# http 서비스 로깅 예시
/var/log/httpd/*log {
	daily
	rotate 30
	size 100M
	compressed

	#로그 로테이트 후 서비스 재시작
	postrotate 
		/bin/systemctl reload httpd.service & > dev/null || true
	endscript
}

# tomcat 서비스 로깅 예시
/usr/local/tomcat/logs/catalina.out {
	rotate 365
	size 100M
	compress

	#로그 파일 복사 후 복사한 부분을 잘라내는 형태로 로그를 로테이트함
	copytruncate

	#로그파일이 없어도 오류가 발생하지 않음
	missingok
}
```

##### 실행
- logwatch와 동일하게 crond에 의해 실행됨
  `/etc/cron.daily/logrotate`
```bash
#!/bin/sh

/usr/sbin/logrotate /etc/logrotate.conf
EXITVALUE=$?
if [ $EXITVALUE != 0 ]; then
    /usr/bin/logger -t logrotate "ALERT exited abnormally with [$EXITVALUE]"
fi
exit 0

```

### 로그서버
- 여러 서버의 로그를 로깅 서버로 보내고 모니터링한다.
- 로그 추적이 쉬워짐
- 해킹에 대비할 수 있음 (해커는 로그를 삭제한다)
#### 로그 서버 구축

rsyslog를 이용하거나 다른 패키지를 이용할 수도 있다. 아래 예제에서는 mariadb에 로그를 기록하기 위해 rsyslog-mysql을 사용했다.

>[!info] 전제 조건 
> mariaDB 혹은 mysqlDB 설치 - `mariadb-server`
> apache webserver 설치 - `httpd`
> php 설치 - `php`, `php-mysql`, `php-gd`
##### DB(rsyslog) 설치 및 설정
- mariadb용 rsyslog 패키지 설치
  `yum install rsyslog-mysql`
- 테이블 스키마 확인
  `rpm -ql rsyslog-mysql`
  ![[Pasted image 20240819071012.png]]
- `cat /usr/share/doc/rsyslog-8.24.0/mysql-createDB.sql`
  ![[Pasted image 20240819071119.png]]
	- 위 파일의 내용을 mariaDB에 적용해야 함. 내용은 아래와 같음
	- Syslog DB 생성
	- SystemEvents, SystemEventProperties 테이블 생성
- mysql에 적용
  `mysql -u root < /usr/share/doc/rsyslog-8.24.0/mysql-createDB.sql`
- 생성한 DB를 사용할 사용자 생성 및 권한 부여
  ![[Pasted image 20240819071805.png]]
  생성 후 `FLUSH PRIVILEGES;` 명령어로 설정을 적용해야 한다.

##### rsyslog 설정
외부 시스템에서 로그를 받을 수 있게 설정하고, 로그를 DB서버에 저장할 수 있도록 설정

- `vi /etc/rsyslog.d/logserver.conf`
```bash
#UDP syslog 수신 모듈
$ModLoad imudp
$UDPServerRun 514

#TCP syslog 수신 모듈
$ModLoad imtcp
$TCPServerRun 514

#Mysql 저장 모듈
$ModLoad ommysql

# 모든 로그 DB에 저장
*.* :ommysql:localhost,Syslog,syslog,{위에서 설정한 암호}
```

##### 실행
- rsyslog 재시작
  `systemctl restart rsyslog`

##### 방화벽 해제
`firewall-cmd --permanent --add-port=514/tcp --add-port=514/udp`
`firewall-cmd --reload`

#### Syslog 전송 클라이언트 설정
##### Linux 클라이언트 설정
- `/etc/rsyslog.conf` 파일에 아래 내용 추가
```bash
...

*.*   @{log-server-ip}
```

- 서비스 재시작
`systemctl restart rsyslog`

##### Windows 클라이언트 설정
- http://www.syslogserver.com/download.html 사이트에서 프로그램 다운로드
- 프로그램 인스톨 → 로그서버 IP 주소 입력 → Start Services 버튼 클릭

#### 저장된 로그 확인
위 설정대로 로그 서버와 클라이언트 서버를 구성했다면, 로그 서버에 수집한 내용이 저장될 것이다. 
##### CLI
- `cat`, `tail`, `more` 등의 명령어로 로그 파일을 출력
  `tail /var/log/messages` : 로그 파일 조회
- `/var/log/*` 로그 파일 저장 : 로컬 및 원격 시스템 로그를 수신하고 보관한다.

##### MariaDB
아래 순서대로 로그 조회
- `mysql -usyslog -p Syslog`
- `select * from SystemEvents limit 10;`

DB에 로그를 저장하면 데이터가 많아질수록 테이블이 커지므로 검색이 오래 걸린다. 이에 대비하기 위해서 **테이블 분리 및 파티셔닝이 필요**하다.

#### 번외, LogAnalyzer 구축
로그 서버에 구축한 로그를 쉽게 모니터링 할 수 있게 도와주는 툴

##### 설치
> [!info] 필요 패키지
> - `httpd`(apache 웹서버)
> - php 관련 패키지

- 다운로드 : http://loganalyzer.adiscon.com/downloads
- 설치
```cli
cd /usr/local/src
wget http://download.adiscon.com/loganalyzer/loganalyzer-3.6.6.tar.gz
tar xvfp loganalyzer-3.6.6.tar.gz  -C /var/www/html
cd /var/www/html/loganalyzer-3.6.6/src
sh ../contrib/configure.sh
```

- 웹 브라우저 접속
	- 192.168.0.1/loganalyzer-3.6.6/src/install.php 접속
	- Basic Configuration
		- Automatically resolved IP Addresses (inline) - No
		- Enable user database - Yes
		- DB name - Syslog
		- DB user - syslog
		- DB pass - {설정한 암호}
	- Creating the main useraccount
		- 임의의 웹 계정 정보 설정
	- Create the first source for syslog messages - DB 정보 설정
		- source type - mysql Native
		- select view - syslog fields
		- DB host - localhost
		- DB name - syslog
		- DB pass - {설정한 암호}
		- DB table name - SystemEvents

##### 접속
- http://192.168.0.1/loganalyzer-3.6.6/src
- 접속 후 로그 내용 및 통계 확인 가능
###### 한글 깨짐 수정
- 상단 메뉴 Admin Center > Default character encoding > UTF-8 설정

##### Reference
- https://loganalyzer.adiscon.com/
- https://insteadoview.tistory.com/12

# 자동화

| 명령어      | 용 도                                                   |
|-------------|---------------------------------------------------------|
| ps          | 프로세스 조회                                            |
| pgrep       | 프로세스 이름으로 PID조회                                |
| kill        | 프로세스에 신호전달 (프로세스 kill 용도)                 |
| while       | 셸 스크립트 반복문                                       |
| if          | 셸 스크립트 조건문                                       |
| sleep       | 지정된 시간(초) 만큼 대기                                |
| mysqladmin  | MySQL(MariaDB) 관리자 (CUI)                              |
| mysql       | MySQL(MariaDB) 클라이언트 (CUI)                          |
| read        | 셸 스크립트에서 키보드 입력받음                          |
| case        | 셸 스크립트 조건문                                       |
| mysqldump   | MySQL(MariaDB) 백업 프로그램 (CUI)                       |
| for         | 셸 스크립트 반복문                                       |
| ping        | ICMP 프로토콜을 이용한 네트워크 점검 툴                  |
| rsync       | 빠르고, 다음도 네트워크 및 로컬 복사 프로그램            |
| crond       | 리눅스 및 유닉스에서 사용되는 시간기반 작업 스케줄러     |
| crontab     | 사용자설정 crontab 관리 프로그램                         |
| LSCP        | 리눅스 점검 프로그램                                      |

### 쉘 스크립트
#### Apache 웹서버 자동 재시작 스크립트
- `httpd` 프로세스의 개수를 모니터링하며, 그 개수가 500개 이상일 때 `httpd` 서비스를 재시작하는 기능 수행
```bash
# 무한 루프를 시작합니다.
while ( true ); do
    
    # httpd 프로세스의 개수가 500개 이상인지 확인합니다.
    # pgrep -x httpd: httpd 프로세스의 정확한 이름을 가진 프로세스를 찾습니다.
    # wc -l: 프로세스의 개수를 셉니다.
    if [ "`$pgrep -x httpd | wc -l`" -ge "500" ]; then
        # httpd 프로세스가 500개 이상이면 httpd 서비스를 재시작합니다.
        systemctl restart httpd
    fi
    
    # 1초간 대기한 후 다시 루프를 반복합니다.
    sleep 1
done

```

#### MariaDB(MySQL) DB관리 유틸리티
- MariaDB에 대한 간단한 메뉴 기반 인터페이스를 제공
```bash
# MySQL 루트 계정의 비밀번호를 변수에 저장합니다.
mysqlpw="비밀번호"

# 무한 루프를 시작합니다.
while ( true ); do
    # 화면을 깨끗하게 정리합니다.
    clean
    
    # 메뉴를 출력합니다.
    echo '
    1. 프로세스 리스트 보기
    2. MariaDB 접속
    3. database 리스트 보기
    q. 끝내기
    '
    
    # 사용자로부터 번호 입력을 받습니다.
    echo -n "번호 선택: "
    read no

    # 사용자가 입력한 번호에 따라 작업을 수행합니다.
    case $no in
        "1")
            # 프로세스 리스트를 출력합니다.
            echo "show processlist;" | mysql -u"root" -p"$mysqlpw" ;;
        "2")
            # MariaDB에 접속합니다.
            mysql -u"root" -p"$mysqlpw" ;;
        "3")
            # 데이터베이스 리스트를 출력합니다.
            echo "show databases;" | mysql -u"root" -p"$mysqlpw" ;;
        "q")
            # 스크립트를 종료합니다.
            exit 0 ;;
    esac
done
```

#### MariaDB(MySQL) DB백업 유틸리티
- MySQL 서버에서 모든 데이터베이스와 해당 데이터베이스 내의 테이블을 순차적으로 덤프하여 각각의 테이블을 SQL 파일로 저장하는 기능을 수행
```bash
# MySQL 루트 계정의 비밀번호를 변수에 저장합니다.
db_root_pw='비밀번호'

# MySQL 서버에서 데이터베이스 목록을 가져옵니다.
db_list=`echo "show databases;" | mysql -N -uroot -p"$db_root_pw"`

# 각 데이터베이스에 대해 작업을 수행합니다.
for db in $db_list ; do
    # 해당 데이터베이스에서 테이블 목록을 가져옵니다.
    table_list=`echo "show tables" | mysql -N -uroot -p"$db_root_pw" $db`
    
    # 각 테이블에 대해 작업을 수행합니다.
    for table in $table_list ; do
        # 테이블을 덤프하여 SQL 파일로 저장합니다.
        mysqldump -uroot -p"$db_root_pw" $db $table > $db.${table}.sql
    done
done
```

#### ping을 이용한 서버 모니터링
- `server` 배열에 저장된 IP 주소들에 대해 ping 테스트를 수행하여, 해당 서버가 정상적으로 응답하는지 여부를 확인
```bash
# 서버 IP 주소를 배열에 저장합니다.
server[0]="192.168.0.100"
server[1]="192.168.0.1"

# 배열에 저장된 모든 서버에 대해 반복문을 실행합니다.
for (( i=0 ; i<${#server[*]} ; i++ )); do
    # 각 서버에 대해 ping 명령어를 사용하여 연결을 테스트합니다.
    # -c 1: 1회 ping 요청
    # -w 1: 1초 동안 응답을 기다림
    # &> /dev/null: 명령어 출력 결과를 화면에 출력하지 않음
    ping -c 1 -w 1 ${server[$i]} &> /dev/null
    
    # ping 명령어의 종료 상태($?)를 확인하여 연결 상태를 판단합니다.
    if [ "$?" == "0" ]; then
        # 종료 상태가 0이면 서버가 정상임을 출력합니다.
        echo "${server[$i]} .. 정상"
    else
        # 종료 상태가 0이 아니면 서버가 비정상임을 출력합니다.
        echo "${server[$i]} .. 비정상"
    fi
done
```

#### 트래픽 점검(측정) 유틸리티
- 네트워크 인터페이스의 수신 및 송신 속도를 일정 간격으로 모니터링하는 기능 제공
- 사용자가 지정한 네트워크 장치 이름(`eth0` 등)과 주기(`delay`)를 인자로 받아, 해당 인터페이스의 현재 수신 및 송신 속도를 Kbit/sec 단위로 계산하여 출력
```bash
# 첫 번째 인자가 비어있으면 사용법을 출력하고 스크립트를 종료합니다.
if [ "$1" == "" ]; then
    echo "사용법: $0 장치명 [delay]"  # 사용법 출력
    echo "예) $0 eth0 3"  # 예시 출력
    exit 1
fi

# 두 번째 인자가 비어있으면 delay를 3초로 설정하고, 그렇지 않으면 주어진 값을 사용합니다.
if [ "$2" == "" ]; then delay=3; else delay=$2; fi

# 헤더를 출력합니다.
echo "시간 : 수신(Kbit/Sec) / 송신(Kbit/Sec)"

# 무한 루프를 시작합니다.
while ( true ); do
    # 첫 번째 수신과 송신 바이트를 읽어옵니다.
    rx1=`grep $1 /proc/net/dev | awk '{print $1}' | sed 's/.*://;'`
    tx1=`grep $1 /proc/net/dev | awk '{print $9}'`
    
    # 설정된 delay만큼 대기합니다.
    sleep $delay
    
    # 두 번째 수신과 송신 바이트를 읽어옵니다.
    rx2=`grep $1 /proc/net/dev | awk '{print $1}' | sed 's/.*://;'`
    tx2=`grep $1 /proc/net/dev | awk '{print $9}'`
    
    # 수신 및 송신 속도를 계산합니다. (1024/8 = 128로 나누어 Kbit로 변환)
    rx3=$(( ( (rx2-rx1)/128/delay) ))
    tx3=$(( ( (tx2-tx1)/128/delay) ))
    
    # 현재 시간과 함께 수신 및 송신 속도를 출력합니다.
    echo "`date +%k:%M:%S` :  $rx3 / $tx3"
done
```

#### 요일별 차등백업 프로그램
- 매일 백업 수행
- 데이터는 일주일간 유지
- 변경(추가/삭제/수정) 데이터만 백업
```bash
# 스크립트의 언어 환경을 영어로 설정합니다.
export LANG=en

# 오늘의 요일을 변수에 저장합니다.
week=`date '+%A'`

# 백업 디렉토리를 오늘의 요일에 따라 설정합니다.
backup_dir="/backup/$week"

# sync_bak 함수 정의: 두 디렉토리를 동기화하는 함수입니다.
function sync_bak {
    from=$1  # 동기화할 원본 디렉토리 경로
    to=$2    # 동기화할 대상 디렉토리 경로
    
    # 대상 디렉토리가 존재하지 않으면 생성합니다.
    if [ ! -d "$to" ]; then mkdir -p $to ; fi
    
    # rsync를 사용하여 원본 디렉토리를 대상 디렉토리로 동기화합니다.
    # -a: 아카이브 모드 (파일 속성 유지, 심볼릭 링크 처리 등)
    # -v: 동작을 자세히 출력
    # --delete: 대상 디렉토리에 원본에 없는 파일이 있으면 삭제
    rsync -av --delete $from $to
}

# /home/ 디렉토리를 백업 디렉토리 내의 /home/에 동기화합니다.
sync_bak /home/ $backup_dir/home/

# MySQL 데이터 디렉토리를 백업 디렉토리 내의 /mysql-data/에 동기화합니다.
sync_bak /usr/local/mysql/data/ $backup_dir/mysql-data/

```

- 위 프로그램을 `cron`에 등록해서 하루에 한 번 실행하면 주기적으로 백업할 수 있다.
### Cron : 스케줄에 따라 커맨드 실행
- 리눅스 및 유닉스에서 사용하는 시간 기반 작업 스케줄러
- 주기적으로 스크립트 및 명령어를 수행할 수 있다.
- 예를 들어, 백업, 동기화 등의 작업에 이용할 수 있다.

![[Pasted image 20240819180130.png]]

| 주기       | 디렉토리               | 실행시간               | 실행 주체                                                                                         |
|------------|------------------------|------------------------|---------------------------------------------------------------------------------------------------|
| 매시       | /etc/cron.hourly/       | 매시 1분               | /etc/cron.d/0hourly에 의해 매시 실행                                                               |
| 매일       | /etc/cron.daily/        | 매일 03시 5분~45분 사이 | /etc/cron.hourly/0anacron에 의해 매일 anacron -S가 실행되고, anacron 설정(/etc/anacron)에 따라 매일 03시 5분~45분 간의 지정시간을 가지고 매일 실행 |
| 매주       | /etc/cron.weekly/       | 매주 03시 25분~45분 사이 | /etc/cron.hourly/0anacron에 의해 매일 anacron -S가 실행되고, anacron 설정(/etc/anacron)에 따라 매주 03시 25분~45분 간의 지정시간을 가지고 매주 실행된다. 요일은 설정된 것이 없으며 최초 1회 실행되고 난 후 그 주의 동일한 날이 실행된다. 만약 처음 목요일에 실행되었다면 매주 목요일에 실행될 것이다. |
| 매월       | /etc/cron.monthly/      | 매월 03시 45분         | /etc/cron.hourly/0anacron에 의해 매일 anacron -S가 실행되고, anacron 설정(/etc/anacron)에 따라 매월 3시 45분에 매월 실행된다. 매월 1월 1일 실행된다.  |

#### Cron 설정 내역 확인
- `crond` 기본 설치 후 주기적으로 수행되는 작업 목록

| 항목      | 디렉토리               | 파일                    | 내용                                                                 |
|-----------|------------------------|-------------------------|----------------------------------------------------------------------|
| 기본      | /etc/cron.d/            | 0hourly                 | 매시 1분 /etc/cron.hourly/* 실행                                       |
|           |                         | raid-check              | RAID 점검, 매일 1시 0분 raid-check 실행                               |
|           |                         | sysstat                 | 시스템 정보 수집, 매 10분마다 sa1 1 1 실행, 매일 23시 53분 sa2 -A 실행  |
|           |                         | unbound-anchor          | DNSSEC Root key 점검, 매월 1일 3시 1분 실행                           |
| 기본      | /etc/                   | crontab                 | CentOS7로 설정된 작업 무, 단, 메일은 root로 보내게 설정               |
| 사용자    | /var/spool/cron/        | *                       | 초기 사용자 cron 무                                                    |
| 매시      | /etc/cron.hourly/       | 0anacron                | 매시 anacron -S 실행                                                  |
|           |                         | 0yum-hourly.cron        | 매시 yum 업데이트 체크                                                |
|           |                         | 0logwatch               | logwatch 실행                                                         |
|           |                         | 0yum-daily.cron         | 매일 yum 업데이트 체크                                                |
|           |                         | logrotate               | logrotate 실행                                                        |
| 매일      | /etc/cron.daily/        | mandb                   | mandb 실행, man 페이지 인덱스 캐시 생성 및 갱신                        |
|           |                         | man-db.cron             | -                                                                    |
|           |                         | mlocate                 | updatedb 실행, mlocate를 위해 DB 업데이트                              |
| 매주      | /etc/cron.weekly/       | -                       | -                                                                    |
| 매월      | /etc/cron.monthly/      | -                       | -                                                                    |

#### Cron 설정
- 아래 방법 지원(crontab을 이용하는 것이 편리함)

| 방법                          | 장점                                                                            | 단점                                              |
|-------------------------------|---------------------------------------------------------------------------------|---------------------------------------------------|
| /etc/cron.d/에 파일생성        | 용도별로 파일을 생성하여, 다양한 시간 다양한 명령을 실행할 수 있다.               | 일반 사용자가 스케줄 관리 불가                      |
| /etc/crontab 내용 수정         | 기본 설정파일                                                                    | 일반 사용자가 스케줄 관리 불가                      |
| crontab 이용 (/var/spool/cron/*)| - 일반 사용자 스케줄 관리 가능                                                   | -                                                 |
|                                | - 설정 자동 검증                                                                | -                                                 |
|                                | - 편집 후 바로 적용                                                              | -                                                 |
| anacron (/etc/cron.hourly..)   | - 부하에 따른 지연 분산 실행                                                     | - 정확하지 않은 시간에 실행                        |

##### crontab을 이용한 cron 관리
- `export EDITOR=vi` //기본 에디터를 vi로 설정한다. (설정을 영구 유지하려면 `/root/.bash_profile`에 저장)
- `crontab -e` 명령어를 입력하면 크론 설정을 할 수 있는 에디터가 열린다.
```bash
#backupWeek.sh 파일 권한은 7xx 이어야 한다.
04 01 * * * /root/backupWeek.sh
#분 시 일 월 요일 명령어

#분 : 0~59
#시 : 0~23
#일 : 1~31
#월 : 1~12 또는 jan~dec
#요일 : 0~7 또는 sun~sat, 일요일은 0 또는 7

#아래와 같이 응용 가능
04 01 * * 2-6 /root/backupWeek.sh
# 화~토요일 3일간 백업 수행
```

###### 필드 형식

| 형식  | 설명                                                                   |
| --- | -------------------------------------------------------------------- |
| *   | 그 시간 단위 전체를 의미<br>예) 분 필드에 *가 있을 경우 매분을 뜻한다.                         |
| -   | 숫자의 범위를 의미<br>예) 분 필드에 1-5가 있을 경우 1분, 2분, 3분, 4분, 5분을 뜻한다.           |
| ,   | 나열된 수를 의미<br>예) 분 필드에 1,5-10,40-50으로 설정한 경우 1분, 5분~10분, 40~50분을 뜻한다. |
| /   | 특정 단위로 건너 뛸 때 사용<br>예) 분 필드에 */5로 설정한 경우 매 5분마다를 뜻한다.                |

###### 확장 형식

| 형식        | 의미                      |
|-------------|---------------------------|
| @reboot     | 리부팅 후에 1회           |
| @yearly     | 매년 1월 1일 0시 0분       |
| @annually   | 매년 1월 1일 0시 0분       |
| @monthly    | 매월 1일 0시 0분           |
| @weekly     | 매주 일요일 0시 0분        |
| @daily      | 매일 0시 0분               |
| @hourly     | 매시 0분                   |

> [!info] 날짜와 요일이 동시에 지정된 경우 모두 실행한다는 의미이다.
> ```bash
> 04 01 1,15 * 2 /root/backupWeek.sh
>```
>위와 같이 설정할 경우 매월 1, 15일 1시 4분 + 매주 화요일 1시 4분에 실행됨

##### 설정 확인
`crontab -l`

##### 쉘 스크립트를 사용한 작업 추가
- crontab 편집모드를 사용하지 않고 추가하기
```cli
crontab -l > /tmp/crontmp
echo "* * * * * /root/checkProc.sh" >> tmp/cronTmp
crontab /tmp/cronTmp
```

##### 다른 사용자의 Cron 편집
`crontab -e -u sbkong` //root만 사용 가능

##### crontab 사용자 제한
- `/etc/cron.allow` : 이 파일에 추가된 사용자는 사용 가능
- `etc/cron.deny` : 이 파일에 추가된 사용자는 사용 불가
- 우선순위 : `cron.allow` > `cron.deny`
	- 두 파일 모두에 사용자가 없으면 사용 가능
	- 두 파일 모두에 사용자가 있으면 사용 가능

##### `/etc/crontab` 파일 편집으로 cron 관리
```bash
SHELL=/bin/bash    # 크론 작업을 실행할 셸을 Bash로 지정합니다.
PATH=/sbin:/bin:/usr/sbin:/usr/bin    # 크론 작업에서 사용할 경로를 지정합니다.
MAILTO=root    # 크론 작업의 출력 결과나 에러 메시지를 받을 이메일 주소를 지정합니다.

# For details see man 4 crontabs
# crontab에 대한 자세한 설명을 보려면 'man 4 crontabs'를 참조하세요.

# Example of job definition:
# 작업 정의 예시:

# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name  command to be executed
# *  *  *  *  * 사용자 이름  실행할 명령어

# 위의 주석은 crontab에서 각 필드가 의미하는 바를 설명합니다:
# - 첫 번째 필드: 분 (0 - 59)
# - 두 번째 필드: 시간 (0 - 23)
# - 세 번째 필드: 달의 일 (1 - 31)
# - 네 번째 필드: 월 (1 - 12) 또는 jan, feb, mar 등
# - 다섯 번째 필드: 요일 (0 - 6) (일요일=0 또는 7) 또는 sun, mon, tue 등
# - 여섯 번째 필드: 작업을 실행할 사용자 이름 (시스템 크론탭에 적용)
# - 일곱 번째 필드: 실행할 명령어

```

##### `/etc/cron.d/`에 파일생성으로 cron 관리
- RPM 패키지를 설치 시 추가되는 주기적인 작업을 설정하기 위해서 사용함

### LSCP(Linux System Check Program)
- [[Linux-System-Check-Project]]

# 번외, 60초 안에 시스템 현황 파악하기
| 명령어                 | 설명                                                      |
| ------------------- | ------------------------------------------------------- |
| `uptime`            | 시스템의 현재 시간, 가동 시간, 현재 로그인한 사용자 수, 그리고 시스템 로드 평균을 출력합니다. |
| `dmesg\|tail`       | 시스템 부팅 시와 커널에서 출력된 메시지의 최근 부분을 확인합니다.                   |
| `vmstat 1 -S m`     | 메모리, 프로세스, I/O, CPU 활동 등의 시스템 성능 통계를 1초 간격으로 출력합니다.     |
| `mpstat -P ALL 1`   | 각 CPU 코어의 사용률을 1초 간격으로 출력합니다.                           |
| `pidstat 1`         | 각 프로세스의 CPU 사용량을 1초 간격으로 출력합니다.                         |
| `iostat -xz 1`      | 각 디스크 장치의 I/O 통계를 1초 간격으로 출력하며, 자세한 정보를 포함합니다.          |
| `free -m`           | 시스템 메모리의 사용량을 메가바이트 단위로 출력합니다.                          |
| `sar -n DEV 1`      | 네트워크 장치의 트래픽 통계를 1초 간격으로 출력합니다.                         |
| `sar -n TCP,ETCP 1` | TCP 연결 상태와 오류에 대한 통계를 1초 간격으로 출력합니다.                    |
| `top`               | 시스템의 실시간 프로세스 상태를 보여주며, CPU 및 메모리 사용량 등을 확인할 수 있습니다.    |
- 일부 커맨드들은 **sysstat package** 을 설치해야 함

### `uptime`
![[Pasted image 20240815181637.png]]
#### 평균 로드율
- 1분, 5분, 15분 의 평균 프로세스 사용을 보여준다.

#### 부하율 계산
- 8 코어 CPU에서 5개의 프로세스가 사용중이었다면,
  $5/8=0.625$ → 약 62% 부하가 걸려있음

> [!info] CPU 개수 확인 명령어
> `grep -c processor /proc/cpuinfo`

### `dmesg | tail`
- 시스템 메세지를 확인할 수 있는 커맨드. 부팅시부터 시작해서 모든 커널메세지가 출력됨
![[Pasted image 20240815183104.png|error; oom-killer(out of memory)와 TCP request 드랍 발견]]

### `vmstat 1 -S m`
![[Pasted image 20240815183826.png]]
- **r / b**: CPU에서 동작중인 프로세스의 숫자입니다. CPU 자원이 포화(saturation)가 발생하는지 확인. `r` 값이 CPU의 값보다 큰 경우에 포화되어 있다고 해석된다.
	- r ; Foreground / b ; Background
- **free**: free memory를 mb단위(`-S m` option)로 나타냄
- **si, so**: Memory swap-in과 swap-out에 대한 값. 0이 아니라면 현재 시스템에 메모리가 부족한것이다.
- **us, sy, id, wa, st**: 모든 CPU의 평균적인 CPU time을 측정할 수 있다. 각각 user time, 커널에서 사용되는 system time, idle, wait I/O 그리고 stolen time순이다(stolen time은 hypervisor가 가상 CPU를 서비스 하는 동안 실제 CPU를 차지한 시간을 이야기한다.).
### `mpstat -P ALL 1`
![[Pasted image 20240815184332.png]]
- CPU time을 CPU 별로 측정할 수 있다. 각 CPU별로 불균형한 상태를 확인할 수 있는데, 한 CPU만 일하고 있는 것은 application이 single thread로 동작한다는 이야기다.
### `pidstat 1`
![[Pasted image 20240815184453.png]]
- pidstat은 process당 `top`명령을 수행하는것과 비슷하다. 다만 차이점은 스크린 전체에 표시하는것이 아니라 지속적으로 변화하는 상황을 띄워주기 떄문에 상황변화를 기록하기 좋다.

위 예제를 보면 두개의 java process의 CPU 사용량이 엄청나다. %CPU 항목은 모든 CPU의 전체 사용량을 이야기한다. 따라서 1591%를 사용중인 java process들은 16CPU 가까이 사용중임을 나타내는것이다.
### `iostat -xz 1`
- block device(SSD/HDD) 동작 확인
![[Pasted image 20240815184549.png]]

- r/s, w/s rkB/s, wkB/s: read 요청과 write 요청, read kB/s, write kB/s를 나타낸다. 어떤 요청이 가장 많이 들어오는지 확인해볼 수 있는 중요한 지표다. 성능 문제는 생각보다 과도한 요청때문에 발생하는 경우도 있기 때문이다.
- await: I/O처리 평균 시간을 밀리초로 표현한 값이다. application한테는 I/O요청을 queue하고 서비스를 받는데 걸리는 시간이기 때문에 application이 이 시간동안 대기하게 된다. 일반적인 장치의 요청 처리 시간보다 긴 경우에는 블럭장치 자체의 문제가 있거나 장치가 포화된 상태임을 알 수 있다.

### `free -hm`
![[Pasted image 20240815185000.png]]
- buffers: Block 장치 I/O의 buffer 캐시, 사용량
- cached: 파일 시스템에서 사용되는 [page cache](https://brunch.co.kr/@alden/25)의 양
  위 값들이 0에 가까워 지면 안된다. 이는 곧 높은 Disk I/O가 발생하고 있음을 의미한다(iostat으로 확인 가능). 위 예제는 각각 59MB, 541MB로 괜찮은 정도에 속한다.
- `-/+ buffers/cache`는 사용중인 메모리와 여유 메모리의 양을 나타낸다. 리눅스는 빠르게 다시 애플리케이션에 메모리가 할당될 수 있도록 캐시메모리를 사용한다. 따라서 캐시 메모리도 여유 메모리에 포함되어 보여야한다. 캐시메모리 또한 여유메모리로 계산하지 않는 착각으로 인해서 [linuxatemyram](http://www.linuxatemyram.com/)란 사이트까지 있다.

### `sar -n DEV 1`
- network throughput(Rx, Tx KB/s)을 측정할수 있다.
![[Pasted image 20240815185020.png]]
- 위 예제에서는 `eth0`의 수신량이 약 22Mbytes/s(21999.10rxkB/s)이다. 이는 176Mbits/s인데 한계인 1Gbit/s에 아직 많이 못 미치는 값이다.
- `%ifutil`은 대부분의 장치에서 제대로 측정하지 못한다.

### `sar -n TCP,ETCP 1`
- TCP 통신량 요약
![[Pasted image 20240815185204.png]]
- active/s: 로컬에서부터 요청한 초당 TCP 커넥션 수를 보여준다 (예를들어, connect()를 통한 연결).
- passive/s: 원격으로부터 요청된 초당 TCP 커넥션 수를 보여준다 (예를들어, accept()를 통한 연결).
- retrans/s: 초당 TCP 재연결 수를 보여준다.

> [!info]
> - active와 passive 수를 보는것은 서버의 부하를 대략적으로 측정하는데에 편리하다. 위 설명을 보면 active를 outbound passive를 inbound 연결로 판단할 수 있는데, 꼭 그렇지만은 않다. (예를들면 localhost에서 localhost로 연결같은 connection)
> - retransmits은 네트워크나 서버의 이슈가 있음을 이야기한다. 신뢰성이 떨어지는 네트워크 환경이나(공용인터넷), 서버가 처리할 수 있는 용량 이상의 커넥션이 붙어서 패킷이 드랍되는것을 이야기한다. 위 예제에서는 초당 하나의 TCP 서버가 들어오는것을 알 수 있다.
### `top`
`top` 명령어는 위에서 체크해본 다양한 측정치를 쉽게 체크할 수 있다. 시스템 전반적으로 값을 확인하기 쉽다는 장점이 있다. 화면이 지속적으로 바뀌는 점 떄문에 패턴을 찾는것이 어렵다. 일시적으로 멈추는 현상을 잡기 위해서도 화면을 주기적으로 빠르게 멈춰주지 않으면 찾기 힘들다
- Ctrl+S : 업데이트 중지
- Ctrl+Q : 업데이트 재개
- Enter : 새로고침
![[Pasted image 20240815185351.png]]
