- **리눅스를 배우는 이유** : 서버 운영 / 개발을 하기 위해서 → 설치 및 구축보다 운영/관리의 빈도가 압도적으로 높다.

# 개요
### IT 인프라 구성
- e.g. 복지콜 시스템 구성도
  ![[Pasted image 20240815164012.png]]

### 영역 구분
- IDC : 인터넷, 백본, 전원(UPS), 항온/항습 
- 정보 보호 시스템 : 방화벽, IPS, IDS, 웹 방화벽, DDOS 방어 장비
- 네트워크 장비 : 백본, 라우터, 스위치, 브릿지
- 서버 : 웹, DB, SMS, CTI

#### 관리 영역
![[Pasted image 20240815170645.png]]

#### 업무 영역
  ![[Pasted image 20240815164137.png]]

| 항 목                    | 업무내용                                                                                                                                                                                                                                                                           | 업무주기   |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------ |
| 분석/설계/검토               | - 시스템 구성에 대한 분석/설계<br>- 로그 저장 및 관리에 설계<br>- 백업관리와 대한 설계<br>- 장애 재발 방지를 위한 검토                                                                                                                                                                                                   | 월간     |
| H/W구축                  | - 장비 견적/발주/납품<br>- 장애에 대한 부품교체                                                                                                                                                                                                                                                 | 비정기    |
| H/W, N/W 구성 변경         | - 하드웨어 마운트 (랙 케이블, 전원연결)<br>- H/W 추가<br>- N/W 구성 변경                                                                                                                                                                                                                            | 비정기    |
| H/W Upgrade            | - HDD 추가 및 교체<br>- CPU 추가 및 교체<br>- RAM 추가 및 교체<br>- RAID CARD 추가 및 교체                                                                                                                                                                                                         | 비정기    |
| OS Install / Reinstall | - OS 설치<br>- OS 기본 보안 설정<br>- OS 기본 환경 설정                                                                                                                                                                                                                                      | 비정기    |
| SW Install / Reinstall | - OS 및 각 서비스 설치, 설정<br>- 메일, FTP, DNS등 설치 및 설정<br>- 기타 SW 설치<br>- DB 및 WEB 분산 환경 구성                                                                                                                                                                                            | 비정기    |
| Data Migration         | - Data migration<br>- Config migration                                                                                                                                                                                                                                         | 비정기    |
| Tuning                 | - 튜닝을 위한 스트레스 테스트 및 자원 측정<br>- 테스트 완료 후 자원 맞춤 및 튜닝<br>- SW 튜닝<br>- 웹 및 SW 스트레스 테스트 및 자원 측정<br>- 테스트 결과에 대한 반영                                                                                                                                                                  | 필요시    |
| 모니터링                   | - 트래픽 모니터링<br>- 서버 Up&Down 모니터링<br>- 프러세스, 메모리, 부하 감시<br>- 서비스(웹, DB, FTP, DNS, 메일)모니터링                                                                                                                                                                                        | 수시     |
| 정기 점검                  | 1. 보안점검<br>- 백도어, Root, SetUid파일, tmp디렉토리 점검<br>- Listen 포트 점검<br>- Linux 기본 방화벽 (iptables, tcp_wrapper) 점검<br>- 비인가 SW 점검<br>- chkrootkit 을 이용한 rootkit 점검<br>- 보안 패치 신규 권고문 적용 및 패치 이력 관리<br>- 서비스 재설치 및 패치이력 점검<br>- 정기 취약점 점검(Nessus등 활용)<br>- 쉬운 비밀번호 점검 (수시로 계정 추가/삭제 시) | 매월     |
| 예방 점검                  | - 보안패치/보안점검 (크리티컬 이슈 발생 시 수시)                                                                                                                                                                                                                                                  | 매분기    |
| 백업 정책                  | - 백업 정책 설정: 주기, 보관 기간, 백업 대상, 복원 방법<br>- 백업 설정                                                                                                                                                                                                                                 | 비정기    |
| 복원 관리                  | - 복원 이력 관리 (일시/사용/내역)                                                                                                                                                                                                                                                          | 비정기    |
| 장애처리                   | - N/W 장애처리<br>- H/W 장애처리<br>- 설치한 SW 장애처리<br>- 처리 → 원인분석 → 보고/재발 방지<br>- 장애 처리 Hot 라인 구성                                                                                                                                                                                       | 발생시    |
| 설정변경                   | - OS 설정 변경<br>- Application 설정 변경<br>- 기타 설정 변경                                                                                                                                                                                                                                | 필요시    |
| Update/Upgrade         | - 펌웨어 Update<br>- Kernel, OS Update<br>- 서버 S/W 업데이트/업그레이드                                                                                                                                                                                                                     | 필요시    |
| 이력관리 및 리포팅             | - 시스템 구성도 유지<br>- H/W 장비 변경 내역 관리<br>- S/W Update/Patch이력 관리<br>- 백업 및 이력 관리<br>- 장애처리 이력관리<br>- 설정 변경/유지 이력관리                                                                                                                                                                 | 변경, 주기 |
| Documentation          | - OS 설치 문서화<br>- OS 기본 보안 설정 및 환경 설정 문서화<br>- SW 설치에 대한 문서화<br>- Data 이관/마이그레이션 문서화                                                                                                                                                                                            | 비정기    |
##### 대표 명령어 정리
| 명령어                   | 용 도                                        |
|--------------------------|---------------------------------------------|
| gnome-system-monitor     | 시스템 종합 모니터링 프로그램(GUI)             |
| top                      | 시스템 종합 모니터링 도구(TUI)                 |
| htop                     | 향상된 top                                  |
| glance                   | 더욱 향상된 top                              |
| vmstat                   | 시스템 전반적인 사용량 확인                   |
| dstat                    | 시스템의 다양한 상태 모니터링                 |
| sar                      | 시스템 정보 수집, 리포트, 저장                |
| pstree                   | 프로세스 트리 출력                           |
| ps                       | 프로세스 상세정보 확인                       |
| pidstat                  | 과부하 프로세스 조회                         |
| strace                   | 프로세스의 시스템 콜 및 시그널 추적           |
| lsof                     | 열린 파일 및 소켓 조회                       |
| free                     | 메모리 사용량 조회                           |
| slabtop                  | SLAB 모니터링                                |
| iptraf-ng                | 트래픽, 패킷 모니터링 및 통계 도구            |
| ethtool                  | 네트워크 인터페이스 확인 및 설정              |
| netstat                  | 네트워크 인터페이스 통계 및 기타 정보 확인    |
| powertop                 | 전력관련 프로세스 확인 및 절전탐구            |
| cpupower                 | CPU 주파수 확인 및 설정                      |
| df                       | 파일 시스템 사용량 확인                      |
| iotop                    | 각 프로세스별 I/O 사용량 모니터링             |
| iostat                   | 각 디바이스별 I/O 조회                       |
| lsblk                    | 블록 디바이스 및 파일시스템 조회              |
| findmnt                  | 트리형태의 마운트 된 내역 확인               |
| tune2fs                  | 파일시스템 정보 확인                         |
| xfs_info                 | xfs 파일시스템 정보 확인                     |
| lspci                    | PCI 장치 조회                                |
| lsusb                    | USB 장치 조회                                |
| tmon                     | 온도 확인 및 냉각장치 조절                    |

- 효율적인 관리를 위해 솔루션을 사용하기도 함
	- Network Management System
	- System Management System



# 번외, 60초 안에 시스템 현황 파악하기
| 명령어                 | 설명                                                      |
| ------------------- | ------------------------------------------------------- |
| `uptime`            | 시스템의 현재 시간, 가동 시간, 현재 로그인한 사용자 수, 그리고 시스템 로드 평균을 출력합니다. |
| `dmesg\|tail`       | 시스템 부팅 시와 커널에서 출력된 메시지의 최근 부분을 확인합니다.                   |
| `vmstat 1 -S m`     | 메모리, 프로세스, I/O, CPU 활동 등의 시스템 성능 통계를 1초 간격으로 출력합니다.     |
| `mpstat -P ALL 1`   | 각 CPU 코어의 사용률을 1초 간격으로 출력합니다.                           |
| `pidstat 1`         | 각 프로세스의 CPU 사용량을 1초 간격으로 출력합니다.                         |
| `iostat -xz 1`      | 각 디스크 장치의 I/O 통계를 1초 간격으로 출력하며, 자세한 정보를 포함합니다.          |
| `free -m`           | 시스템 메모리의 사용량을 메가바이트 단위로 출력합니다.                          |
| `sar -n DEV 1`      | 네트워크 장치의 트래픽 통계를 1초 간격으로 출력합니다.                         |
| `sar -n TCP,ETCP 1` | TCP 연결 상태와 오류에 대한 통계를 1초 간격으로 출력합니다.                    |
| `top`               | 시스템의 실시간 프로세스 상태를 보여주며, CPU 및 메모리 사용량 등을 확인할 수 있습니다.    |

### `uptime`
![[Pasted image 20240815181637.png]]
#### 평균 로드율
- 1분, 5분, 15분 의 평균 프로세스 사용을 보여준다.

#### 부하율 계산
- 8 코어 CPU에서 5개의 프로세스가 사용중이었다면,
  $5/8=0.625$ → 약 62% 부하가 걸려있음

> [!info] CPU 개수 확인 명령어
> `grep -c processor /proc/cpuinfo`

### `dmesg | tail`
- 시스템 메세지를 확인할 수 있는 커맨드. 부팅시부터 시작해서 모든 커널메세지가 출력됨
![[Pasted image 20240815183104.png|error; oom-killer(out of memory)와 TCP request 드랍 발견]]

### `vmstat 1 -S m`
![[Pasted image 20240815183826.png]]
- **r / b**: CPU에서 동작중인 프로세스의 숫자입니다. CPU 자원이 포화(saturation)가 발생하는지 확인. `r` 값이 CPU의 값보다 큰 경우에 포화되어 있다고 해석된다.
	- r ; Foreground / b ; Background
- **free**: free memory를 mb단위(`-S m` option)로 나타냄
- **si, so**: Memory swap-in과 swap-out에 대한 값. 0이 아니라면 현재 시스템에 메모리가 부족한것이다.
- **us, sy, id, wa, st**: 모든 CPU의 평균적인 CPU time을 측정할 수 있다. 각각 user time, 커널에서 사용되는 system time, idle, wait I/O 그리고 stolen time순이다(stolen time은 hypervisor가 가상 CPU를 서비스 하는 동안 실제 CPU를 차지한 시간을 이야기한다.).
### `mpstat -P ALL 1`
![[Pasted image 20240815184332.png]]
- CPU time을 CPU 별로 측정할 수 있다. 각 CPU별로 불균형한 상태를 확인할 수 있는데, 한 CPU만 일하고 있는 것은 application이 single thread로 동작한다는 이야기다.
### `pidstat 1`
![[Pasted image 20240815184453.png]]
- pidstat은 process당 `top`명령을 수행하는것과 비슷하다. 다만 차이점은 스크린 전체에 표시하는것이 아니라 지속적으로 변화하는 상황을 띄워주기 떄문에 상황변화를 기록하기 좋다.

위 예제를 보면 두개의 java process의 CPU 사용량이 엄청나다. %CPU 항목은 모든 CPU의 전체 사용량을 이야기한다. 따라서 1591%를 사용중인 java process들은 16CPU 가까이 사용중임을 나타내는것이다.
### `iostat -xz 1`
- block device(SSD/HDD) 동작 확인
![[Pasted image 20240815184549.png]]

- r/s, w/s rkB/s, wkB/s: read 요청과 write 요청, read kB/s, write kB/s를 나타낸다. 어떤 요청이 가장 많이 들어오는지 확인해볼 수 있는 중요한 지표다. 성능 문제는 생각보다 과도한 요청때문에 발생하는 경우도 있기 때문이다.
- await: I/O처리 평균 시간을 밀리초로 표현한 값이다. application한테는 I/O요청을 queue하고 서비스를 받는데 걸리는 시간이기 때문에 application이 이 시간동안 대기하게 된다. 일반적인 장치의 요청 처리 시간보다 긴 경우에는 블럭장치 자체의 문제가 있거나 장치가 포화된 상태임을 알 수 있다.

### `free -hm`
![[Pasted image 20240815185000.png]]
- buffers: Block 장치 I/O의 buffer 캐시, 사용량
- cached: 파일 시스템에서 사용되는 [page cache](https://brunch.co.kr/@alden/25)의 양
  위 값들이 0에 가까워 지면 안된다. 이는 곧 높은 Disk I/O가 발생하고 있음을 의미한다(iostat으로 확인 가능). 위 예제는 각각 59MB, 541MB로 괜찮은 정도에 속한다.
- `-/+ buffers/cache`는 사용중인 메모리와 여유 메모리의 양을 나타낸다. 리눅스는 빠르게 다시 애플리케이션에 메모리가 할당될 수 있도록 캐시메모리를 사용한다. 따라서 캐시 메모리도 여유 메모리에 포함되어 보여야한다. 캐시메모리 또한 여유메모리로 계산하지 않는 착각으로 인해서 [linuxatemyram](http://www.linuxatemyram.com/)란 사이트까지 있다.

### `sar -n DEV 1`
- network throughput(Rx, Tx KB/s)을 측정할수 있다.
![[Pasted image 20240815185020.png]]
- 위 예제에서는 `eth0`의 수신량이 약 22Mbytes/s(21999.10rxkB/s)이다. 이는 176Mbits/s인데 한계인 1Gbit/s에 아직 많이 못 미치는 값이다.
- `%ifutil`은 대부분의 장치에서 제대로 측정하지 못한다.

### `sar -n TCP,ETCP 1`
- TCP 통신량 요약
![[Pasted image 20240815185204.png]]
- active/s: 로컬에서부터 요청한 초당 TCP 커넥션 수를 보여준다 (예를들어, connect()를 통한 연결).
- passive/s: 원격으로부터 요청된 초당 TCP 커넥션 수를 보여준다 (예를들어, accept()를 통한 연결).
- retrans/s: 초당 TCP 재연결 수를 보여준다.

> [!info]
> - active와 passive 수를 보는것은 서버의 부하를 대략적으로 측정하는데에 편리하다. 위 설명을 보면 active를 outbound passive를 inbound 연결로 판단할 수 있는데, 꼭 그렇지만은 않다. (예를들면 localhost에서 localhost로 연결같은 connection)
> - retransmits은 네트워크나 서버의 이슈가 있음을 이야기한다. 신뢰성이 떨어지는 네트워크 환경이나(공용인터넷), 서버가 처리할 수 있는 용량 이상의 커넥션이 붙어서 패킷이 드랍되는것을 이야기한다. 위 예제에서는 초당 하나의 TCP 서버가 들어오는것을 알 수 있다.
### `top`
`top` 명령어는 위에서 체크해본 다양한 측정치를 쉽게 체크할 수 있다. 시스템 전반적으로 값을 확인하기 쉽다는 장점이 있다. 화면이 지속적으로 바뀌는 점 떄문에 패턴을 찾는것이 어렵다. 일시적으로 멈추는 현상을 잡기 위해서도 화면을 주기적으로 빠르게 멈춰주지 않으면 찾기 힘들다
- Ctrl+S : 업데이트 중지
- Ctrl+Q : 업데이트 재개
- Enter : 새로고침
![[Pasted image 20240815185351.png]]
